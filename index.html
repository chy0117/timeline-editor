<!-- Timeline Story Editor v2.1 -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>íƒ€ì„ë¼ì¸ ìŠ¤í† ë¦¬ ì—ë””í„°</title>
  <style>
 /* ================================
   Timeline Story Editor v2.2 (FINAL CLEAN)
   - ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ / ì¤‘ë³µ ì œê±° / Step1 ë‹¤í¬ëª¨ë“œ ì„¹ì…˜ êµ¬ë¶„ ê°•í™”
   ================================ */

/* ---------- Theme Variables ---------- */
:root{
  --bg:#020617;
  --fg:#e5e7eb;
  --sidebar-bg:#020617;
  --border:#111827;
  --viewport-bg:#020617;
  --block-bg:#020617;
  --hour-label:#6b7280;
  --hour-line:rgba(31,41,55,0.8);
  --accent:#22c55e;
  --accent-strong:#16a34a;
  --muted:#6b7280;

  /* ---------- Global UI Scale ---------- */
  --ui-label:16px;
  --ui-input:16px;
  --ui-small:14px;
  --ui-radius:16px;
  --ui-pad-y:12px;
  --ui-pad-x:14px;
  --ui-gap:16px;
  --ui-row-gap:10px;
  --ui-min-hit:44px;

    /* ---------- Timeline Grid Colors ---------- */
  --tl-bg: #0b1220;                 /* ë‹¤í¬ íƒ€ì„ë¼ì¸ ë°°ê²½ */
  --tl-label: rgba(229,231,235,0.70);
  --tl-line: rgba(229,231,235,0.18);
  --tl-line-soft: rgba(229,231,235,0.10);
  --tl-boundary: rgba(229,231,235,0.28);

  --tl-boundary-label-bg: rgba(2,6,23,0.85);
  --tl-boundary-label-fg: rgba(229,231,235,0.85);
  --tl-boundary-label-border: rgba(148,163,184,0.22);
}

body.theme-light{
  --bg:#f9fafb;
  --fg:#020617;
  --sidebar-bg:#ffffff;
  --border:#e5e7eb;
  --viewport-bg:#f3f4f6;
  --block-bg:#ffffff;
  --hour-label:#9ca3af;
  --hour-line:#e5e7eb;
  --accent:#22c55e;
  --accent-strong:#15803d;
  --muted:#9ca3af;
   /* ---------- Timeline Grid Colors (Light) ---------- */
  --tl-bg: #ffffff;
  --tl-label: rgba(17,24,39,0.55);
  --tl-line: rgba(17,24,39,0.18);
  --tl-line-soft: rgba(17,24,39,0.10);
  --tl-boundary: rgba(17,24,39,0.25);

  --tl-boundary-label-bg: #ffffff;
  --tl-boundary-label-fg: rgba(17,24,39,0.70);
  --tl-boundary-label-border: rgba(229,231,235,1);
}

*{ box-sizing:border-box; }

/* ---------- Base Layout ---------- */
body{
  margin:0;
  height:100vh;
  display:flex;
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  font-size:var(--ui-input);
}

.sidebar{
  width:360px;
  height:100vh;
  background:var(--sidebar-bg);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  overflow:hidden;          /* âœ… ìŠ¤í¬ë¡¤ì€ ì•„ë˜ .sidebar-scrollì´ ë‹´ë‹¹ */
  padding:0;                /* âœ… íŒ¨ë”©ì€ top/scrollì— ë¶„ë¦¬ */
  z-index:2;
}

/* âœ… ê³ ì • ì˜ì—­ (H1 + STEP NAV) */
.sidebar-top{
  flex:0 0 auto;
  padding:18px 20px 10px;
  background:var(--sidebar-bg);
  border-bottom:1px solid rgba(148,163,184,0.10);
}

/* âœ… ìŠ¤í¬ë¡¤ ì˜ì—­ (STEP íŒ¨ë„ë“¤ ì „ë¶€) */
.sidebar-scroll{
  flex:1 1 auto;
  min-height:0;             /* âœ… ì¤‘ìš”: flex ë‚´ë¶€ overflow ì‘ë™ */
  overflow-y:auto;
  padding:12px 20px 18px;
  display:flex;
  flex-direction:column;
  gap:var(--ui-gap);
}


.main{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:16px;
}

h1{
  font-size:20px;
  margin:0 0 10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  flex-wrap:nowrap;
}

/* ---------- Typography ---------- */
label{
  display:block;
  font-size:var(--ui-label);
  margin-bottom:8px;
  line-height:1.2;
  color:rgba(229,231,235,0.90);
}
body.theme-light label{ color:rgba(2,6,23,0.70); }

.hint{
  font-size:var(--ui-small);
  color:var(--muted);
  line-height:1.45;
  margin:6px 0 0;
}

/* Step1ì—ì„œëŠ” ì„¤ëª… í…ìŠ¤íŠ¸ ìˆ¨ê¹€(ì˜¨ë³´ë”©/ì„¤ëª…ì„œë¡œ ë¶„ë¦¬) */
body[data-step="1"] .hint{ display:none !important; }
#step2Panel .hint,
#step2Panel ul.hint{
  display:none !important;
}
/* ---------- Form Controls ---------- */
input,select,textarea,button{
  font-size:var(--ui-input);
  padding:var(--ui-pad-y) var(--ui-pad-x);
  border-radius:var(--ui-radius);
  border:1px solid var(--border);
  background:var(--bg);
  color:var(--fg);
  min-height:var(--ui-min-hit);
}
input,select,textarea{ width:100%; }
button{ width:auto; cursor:pointer; font-weight:600; margin-top:0; }
textarea{ resize:vertical; min-height:96px; }

input[type="file"]{
  min-height:auto;
  padding:8px 8px;
  border-radius:12px;
  background:transparent;
}

.row{
  display:flex;
  gap:var(--ui-row-gap);
  align-items:center;
}
.row > *{ flex:1; }

/* ---------- Buttons ---------- */
.btn-primary, .btn-secondary{ width:100%; }

.btn-primary{
  background:var(--accent);
  border-color:var(--accent-strong);
  color:#020617;
}
.btn-primary:hover{ background:var(--accent-strong); }

.btn-secondary{
  background:transparent;
  border-color:var(--border);
  color:var(--fg);
}
.btn-secondary:hover{ background:rgba(148,163,184,0.12); }

.btn-theme{
  width:auto !important;
  min-height:40px;
  padding:8px 12px;
  font-size:12px;
  border-radius:999px;
  white-space:nowrap;
  flex-shrink:0;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

.btn-date{
  flex:0 0 auto;
  width:auto;
  min-height:var(--ui-min-hit);
  padding:var(--ui-pad-y) 12px;
  font-size:var(--ui-input);
  margin-top:0;
}
/* ìº˜ë¦°ë” ë²„íŠ¼ full width ë°©ì§€ */
#datePickerBtn.btn-date{
  width:48px !important;
  min-width:48px !important;
  padding:0 !important;
}

/* ---------- Step Navigation ---------- */
.step-nav{
  display:flex;
  gap:10px;
  margin:6px 0 10px;
}
.step-btn{
  flex:1;
  padding:10px 10px;
  font-size:14px;
  border-radius:999px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  cursor:pointer;
  white-space:nowrap;
}
.step-btn.active{
  background:var(--accent);
  border-color:var(--accent-strong);
  color:#020617;
}
.step-panel{ display:none; }
.step-panel.active{ display:block; }
    /* ---------- Step2 Sub Navigation ---------- */
.step2-subnav{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.step2-subnav .sub-btn{
  flex:1;
  padding:10px 10px;
  font-size:14px;
  border-radius:999px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  cursor:pointer;
  white-space:nowrap;
}

.step2-subnav .sub-btn.active{
  background:var(--accent);
  border-color:var(--accent-strong);
  color:#020617;
}

/* ---------- Toggle Buttons (ê³µí†µ) ---------- */
.item-type-toggle,
.animation-mode-toggle,
.title-font-toggle,
.text-font-toggle{
  display:flex;
  gap:6px;
  margin-top:8px;
}

.item-type-toggle .toggle-btn,
.animation-mode-toggle .toggle-btn,
.title-font-toggle .toggle-btn,
.text-font-toggle .toggle-btn{
  flex:1;
  padding:0 10px;
  min-height:44px;
  font-size:18px;
  line-height:1;
  border-radius:999px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  cursor:pointer;
  margin-top:0;
  white-space:nowrap;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

.item-type-toggle .toggle-btn.active,
.animation-mode-toggle .toggle-btn.active,
.title-font-toggle .toggle-btn.active,
.text-font-toggle .toggle-btn.active{
  background:var(--accent);
  border-color:var(--accent-strong);
  color:#020617;
}

/* ë²„íŠ¼ ê¸€ì”¨ê°€ í°íŠ¸ ë¯¸ë¦¬ë³´ê¸°ì²˜ëŸ¼ ë³´ì´ê²Œ */
.title-font-toggle .toggle-btn[data-font="pretendard"],
.text-font-toggle  .toggle-btn[data-font="pretendard"]{
  font-family:"PretendardSemiBoldLocal","Pretendard",system-ui,sans-serif;
}
.title-font-toggle .toggle-btn[data-font="laudrygo"],
.text-font-toggle  .toggle-btn[data-font="laudrygo"]{
  font-family:"LaudrygoLocal",system-ui,sans-serif;
}
.title-font-toggle .toggle-btn[data-font="nanum"],
.text-font-toggle  .toggle-btn[data-font="nanum"]{
  font-family:"NanumNaMuJeongWeonLocal",system-ui,sans-serif;
}
.title-font-toggle .toggle-btn[data-font="bagel"],
.text-font-toggle  .toggle-btn[data-font="bagel"]{
  font-family:"BagelFatOneLocal",system-ui,sans-serif;
}

/* ---------- Speed Row ---------- */
.speed-row{
  display:flex;
  align-items:center;
  gap:8px;
}
.speed-row input[type="range"]{ flex:1; min-height:auto; }
.speed-row span{
  font-size:12px;
  color:var(--muted);
  min-width:40px;
  text-align:right;
}

/* ---------- Block List ---------- */
.block-list{
  list-style:none;
  padding-left:0;
  margin:4px 0 0;
  max-height:180px;
  overflow-y:auto;
  font-size:13px;
}
.block-list li{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  margin-bottom:6px;
  border-radius:10px;
  border:1px solid var(--border);
  cursor:pointer;
  min-width:0;
  overflow:hidden;
}
.block-list span.time{
  flex:1 1 auto;
  min-width:120px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  font-weight:500;
  color:var(--fg);
}
.block-right-group{
  display:flex;
  align-items:center;
  gap:6px;
  flex-shrink:0;
}
.block-list span.count{
  font-size:12px;
  color:var(--muted);
  white-space:nowrap;
}
.block-delete-btn{
  width:22px !important;
  min-width:22px !important;
  height:22px !important;
  padding:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  color:var(--muted);
  background:transparent;
  border:1px solid var(--border);
  border-radius:50%;
  cursor:pointer;
  flex-shrink:0;
}

/* ---------- Step1 Placeholder ---------- */
.step1-placeholder{
  display:none;
  align-items:center;
  justify-content:center;
  font-size:13px;
  color:var(--muted);
  text-align:center;
  padding:16px;
  height:100%;
}

body[data-step="1"] .timeline-viewport{ display:none; }
body[data-step="1"] .step1-placeholder{ display:flex; }
body[data-step="1"] .main{ display:none !important; }
body[data-step="1"] .sidebar{
  width:100% !important;
  max-width:480px;
  margin:0 auto;
  border-right:none;
}
body[data-step="2"] .timeline-viewport,
body[data-step="3"] .timeline-viewport{ display:block; }
body[data-step="2"] .step1-placeholder,
body[data-step="3"] .step1-placeholder{ display:none; }

/* ---------- Timeline Viewport ---------- */
.timeline-viewport{
  width:360px;
  height:640px;
  max-width:100%;
  border-radius:24px;
  background:var(--viewport-bg);
  border:2px solid var(--border);
  overflow-y:auto;
  overflow-x:hidden;
  position:relative;
  box-shadow:0 20px 40px rgba(0,0,0,0.3);
}

/* í¸ì§‘ ëª¨ë“œ ë°°ê²½ ì˜¤ë²„ë ˆì´ */
.timeline-viewport::before{
  content:'';
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.4);
  opacity:0;
  pointer-events:none;
  transition:opacity 0.3s;
  z-index:5;
}
body.theme-light .timeline-viewport::before{ background:rgba(0,0,0,0.2); }
.timeline-viewport.edit-mode::before{ opacity:1; }

.viewport-header{
  position:sticky;
  top:0;
  left:0;
  right:0;
  text-align:center;
  font-size:12px;
  color:var(--muted);
  padding:6px 0;
  background:linear-gradient(to bottom,rgba(2,6,23,0.9),rgba(2,6,23,0));
  z-index:6;
}
body.theme-light .viewport-header{
  background:linear-gradient(to bottom,rgba(249,250,251,0.95),rgba(249,250,251,0));
}

/* ---------- Title Overlay (ì¤‘ì•™) ---------- */
.timeline-title-overlay{
  position:absolute;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  padding:24px;
  text-align:center;
  font-size:32px;
  font-weight:700;
  line-height:1.4;
  background:rgba(0,0,0,0.6);
  color:#f9fafb;
  z-index:7;

  --title-font:"PretendardSemiBoldLocal";
  font-family:var(--title-font),system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}
.timeline-title-overlay > *{
  position:relative;
  z-index:2;
}
body.theme-light .timeline-title-overlay{
  background:rgba(15,23,42,0.25);
  color:#020617;
}
.timeline-title-overlay.titlefont-bagel{ --title-font:"BagelFatOneLocal"; }
.timeline-title-overlay.titlefont-nanum{ --title-font:"NanumNaMuJeongWeonLocal"; }
.timeline-title-overlay.titlefont-pretendard{ --title-font:"PretendardSemiBoldLocal"; }
.timeline-title-overlay.titlefont-laudrygo{ --title-font:"LaudrygoLocal"; }

/* âœ… Title Overlay Background Image Support */
.timeline-title-overlay{
  isolation:isolate; /* pseudo-element z-index ì•ˆì •í™” */
}

.timeline-title-overlay.has-bg{
  background: transparent !important; /* ê¸°ë³¸ rgba ë°°ê²½ ëŒ€ì‹ , bgì‚¬ì§„+ë”¤ì„ ì‚¬ìš© */
}

.timeline-title-overlay.has-bg::before{
  content:"";
  position:absolute;
  inset:0;
  background-image: var(--title-bg-url);
  background-size: cover;
  background-position: center;
  transform: scale(1.05); /* ë¸”ëŸ¬ ê°€ì¥ìë¦¬ í‹° ë°©ì§€ */
  filter: blur(var(--title-bg-blur, 0px));
  z-index:-2;
}

.timeline-title-overlay.has-bg::after{
  content:"";
  position:absolute;
  inset:0;
  background: rgba(0,0,0,var(--title-bg-dim, 0.45)); /* 0~0.8 */
  z-index:-1;
}

/* âœ… Step2 'ì˜ìƒ ì œëª©' íƒ­: íƒ€ì„ë¼ì¸ ëŒ€ì‹  íƒ€ì´í‹€ í˜ì´ì§€ ë ˆì´ì–´ë¥¼ ë³´ì—¬ì¤Œ */
.title-page-layer{
  position:absolute;
  inset:0;
  display:none;
  z-index:6;          /* timeline ìœ„, titleOverlay(7) ì•„ë˜ */
  overflow:hidden;
}

    /* âœ… Title í¸ì§‘ í™”ë©´ì—ì„œë„ ë”¤ ë ˆì´ì–´(ë¸”ëŸ¬ëŠ” JSì—ì„œ imgì— ì§ì ‘ ì ìš©) */
#titleBgDimLayer{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:9997;      /* titleItem(9998) ë°”ë¡œ ì•„ë˜ */
  display:none;
}

body[data-step="2"][data-step2view="title"] #titlePageLayer{
  display:block;
}

body[data-step="2"][data-step2view="title"] #timeline{
  display:none !important;   /* âœ… íƒ€ì„ë¼ì¸ ìˆ¨ê¹€ */
}

/* ì œëª© íƒ­ì—ì„œëŠ” ìŠ¤í¬ë¡¤ í•„ìš” ì—†ìœ¼ë‹ˆ ì ê¹ ë§‰ê¸° */
body[data-step="2"][data-step2view="title"] #viewport{
  overflow:hidden !important;
}


    
/* ---------- Timeline Inner / Grid ---------- */
.timeline-inner{
  position:relative;
  width:100%;
  height:5760px;
   background: var(--tl-bg);      
}


.hour-label{
  position:absolute;
  left:10px;
  width:48px;
  font-weight:700;
  letter-spacing:-0.2px;
  color: var(--tl-label);
  font-size:15px;      /* âœ… ê¸€ì”¨ ì¡°ê¸ˆ í¬ê²Œ */
  line-height:1;
}
.hour-label.active{
  color:var(--accent);
  font-weight:800;
}
    

.hour-line{
  position:absolute;
  left:44px;                       /* âœ… ë¼ë²¨ ì˜ì—­ë§Œ ë‚¨ê¸°ê³  */
  right:10px;
  height:0;
   border-top: 1px dotted var(--tl-line);
  background:none;
}

    .half-line{
  position:absolute;
  left:44px;
  right:10px;
  height:0;
    border-top: 1px dotted var(--tl-line-soft);
}

/* ---------- Day Boundary (24h) ---------- */
.day-boundary{
  position:absolute;
  left:0;
  right:0;
  height:0;
  z-index:2;
  pointer-events:none;
}

.day-boundary-line{
  position:absolute;
  left:44px;
  right:10px;
  height:0;
   border-top: 2px solid var(--tl-boundary);
}

.day-boundary-label{
  position:absolute;
  left:10px;            /* hour-labelê³¼ ê°™ì€ ë¼ì¸ */
  top:-12px;            /* ì„  ìœ„ë¡œ ì‚´ì§ */
  padding:4px 8px;
  border-radius:10px;
  background: var(--tl-boundary-label-bg);
 color: var(--tl-boundary-label-fg);
  font-size:14px;       /* âœ… ê¸€ì”¨ ì¡°ê¸ˆ í¬ê²Œ */
  font-weight:800;
  letter-spacing:-0.2px;
  box-shadow:0 6px 14px rgba(0,0,0,0.06);
  border: 1px solid var(--tl-boundary-label-border);
}
    


/* ---------- Time Block ---------- */
.time-block{
  position:absolute;
  left:60px;
  right:12px;
  border-radius:18px;
  background:transparent;
  border:none;
  padding:4px;
  box-shadow:none;
  overflow:hidden;
  pointer-events:none;
}
.time-block-inner{
  position:relative;
  width:100%;
  height:100%;
  border-radius:14px;
  background:transparent;
}

/* ---------- Timeline Item ---------- */
.timeline-item{
  position:absolute;
  border-radius:12px;
  overflow:hidden;
  cursor:pointer;
  box-shadow:0 0 0 1px rgba(148,163,184,0.4);
  transform-origin:center center;
  background:transparent;
  opacity:1;
  transition:opacity .4s ease;
  z-index:1;
  touch-action: pan-y;
  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
  will-change:transform;
}
.timeline-item.edit-mode,
.timeline-item.editing,
.timeline-viewport.edit-mode .timeline-item{
  touch-action: none; 
}  /* âœ… í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ ì œìŠ¤ì²˜ ì§ì ‘ ì²˜ë¦¬ */
  
.timeline-item.editing{ transition:none; }
.timeline-item.edit-mode{
  box-shadow:0 0 0 3px var(--accent), 0 8px 20px rgba(34,197,94,0.3);
  z-index:10 !important;
}
.timeline-item.dragging{
  transform:scale(1.05);
  box-shadow:0 0 0 3px var(--accent), 0 12px 24px rgba(0,0,0,0.4);
}

.timeline-item img,
.timeline-item video{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
  pointer-events:none;
  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
  backface-visibility:hidden;
  -webkit-backface-visibility:hidden;
  transform:translateZ(0);
  -webkit-transform:translateZ(0);
}

.timeline-item-text{
  width:auto;          /* âœ… 100% ì œê±° */
  height:auto;         /* âœ… 100% ì œê±° */
  display:inline-block; /* âœ… ë‚´ìš© í¬ê¸°ë§Œí¼ */
  padding:6px 8px;
  font-size:24px;
  line-height:1.35;
  color:#f9fafb;
  white-space:pre-wrap;
  word-break:break-word;
  background:transparent;
}
body.theme-light .timeline-item-text{
  color:#111827;
  background:transparent;
}

.timeline-item.reveal-hidden{ opacity:0; }
.timeline-item.reveal-visible{ opacity:1; }

/* ---------- Fullscreen (API) ---------- */
.timeline-viewport:fullscreen,
.timeline-viewport:-webkit-full-screen,
.timeline-viewport:-moz-full-screen,
.timeline-viewport:-ms-fullscreen{
  position:fixed !important;
  top:0;
  left:0;
  width:100vw !important;
  height:100vh !important;
  max-width:100vw !important;
  max-height:100vh !important;
  border-radius:0 !important;
  border:none !important;
  overflow-y:auto !important;
  overflow-x:hidden !important;
}
.timeline-viewport:fullscreen .timeline-inner,
.timeline-viewport:-webkit-full-screen .timeline-inner{
  width:100% !important;
}
@media screen and (orientation:landscape){
  .timeline-viewport:fullscreen,
  .timeline-viewport:-webkit-full-screen{
    width:56.25vh !important;
    max-width:56.25vh !important;
    margin:0 auto !important;
    background:#000 !important;
  }
}

/* ---------- Fullscreen Mask (UI ì—°ì¶œìš©) ---------- */
.fullscreen-mask{
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  height:120px;
  z-index:9999;
  pointer-events:none;
  display:none;
  background:linear-gradient(to top, rgba(0,0,0,0.85), rgba(0,0,0,0.45), rgba(0,0,0,0));
}
body.theme-light .fullscreen-mask{
  background:linear-gradient(to top, rgba(249,250,251,0.95), rgba(249,250,251,0.6), rgba(249,250,251,0));
}

/* ---------- Record Mode (ê°€ì§œ ì „ì²´í™”ë©´) ---------- */
body.record-mode{ overflow:hidden; background:#000; }
body.record-mode .sidebar{ display:none !important; }
body.record-mode .main{ padding:0 !important; }

/* âœ… 9:16 ìœ ì§€ + í™”ë©´ ì¤‘ì•™ ì •ë ¬ (ë ˆí„°ë°•ìŠ¤) */
body.record-mode .timeline-viewport{
  position:fixed !important;
  top:0 !important;
  bottom:0 !important;

  /* 9:16 í­ = ë†’ì´ * 9/16 */
  width: min(100vw, calc(100dvh * 9 / 16)) !important;
  height: 100dvh !important;

  left: 50% !important;
  transform: translateX(-50%) !important;

  max-width: min(100vw, calc(100dvh * 9 / 16)) !important;
  max-height:100dvh !important;

  border-radius:0 !important;
  border:none !important;
  margin:0 !important;
  z-index:9999 !important;
  box-shadow:none !important;
}


.record-exit{
  position:fixed;
  top:12px;
  right:12px;
  width:40px;
  height:40px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.4);
  background:rgba(2,6,23,0.6);
  color:#fff;
  font-size:20px;
  line-height:1;
  display:none;
  z-index:10000;
}
body.theme-light .record-exit{
  background:rgba(249,250,251,0.8);
  color:#111827;
}
body.record-mode .record-exit{
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

/* ---------- Responsive ---------- */
@media (max-width:768px){
  body{ flex-direction:column; height:auto; }

  .sidebar{
    width:100%;
    height:auto;
    border-right:none;
    border-bottom:1px solid var(--border);
  }

  .sidebar-top{
    padding:16px 16px 10px;
  }

  .sidebar-scroll{
    padding:12px 16px 16px;
  }

  .main{ padding:8px; }
  .timeline-viewport{
    width:100%;
    height:70vh;
    border-radius:16px;
  }

  body[data-step="1"] .sidebar{ max-width:100%; border-bottom:none; }
  h1{ font-size:19px; }
}


/* ---------- Local Fonts ---------- */
@font-face{
  font-family:"BagelFatOneLocal";
  src:url("./fonts/BagelFatOne-Regular.ttf") format("truetype");
  font-weight:400;
  font-style:normal;
  font-display:swap;
}
@font-face{
  font-family:"NanumNaMuJeongWeonLocal";
  src:url("./fonts/NanumNaMuJeongWeon.ttf") format("truetype");
  font-weight:400;
  font-style:normal;
  font-display:swap;
}
@font-face{
  font-family:"PretendardSemiBoldLocal";
  src:url("./fonts/Pretendard-SemiBold.woff") format("woff");
  font-weight:600;
  font-style:normal;
  font-display:swap;
}
@font-face{
  font-family:"LaudrygoLocal";
  src:url("./fonts/laudrygo Regular.woff") format("woff");
  font-weight:400;
  font-style:normal;
  font-display:swap;
}

/* =========================================================
   âœ… Step1 Section UI (FINAL)
   - ë‹¤í¬ëª¨ë“œì—ì„œë„ ì„¹ì…˜ ê²½ê³„ê°€ í™•ì‹¤í•˜ê²Œ ë³´ì´ê²Œ (ì¤‘ë³µ ì—†ì´ 1ê°œë§Œ)
   ========================================================= */

.step1-sections{
  display:flex;
  flex-direction:column;
  gap:14px;
}

.s1-section{
  position:relative;
  border-radius:20px;
  padding:14px;

  /* ë‹¤í¬ëª¨ë“œ ë¶„ë¦¬ê° ê°•í™” */
  border:1px solid rgba(148,163,184,0.22);
  background: rgba(255,255,255,0.07);
  box-shadow: 0 10px 22px rgba(0,0,0,0.28);
  overflow:hidden;
}

/* ìƒë‹¨ ë¯¸ì„¸ í•˜ì´ë¼ì´íŠ¸ */
.s1-section::before{
  content:"";
  position:absolute;
  left:0; right:0; top:0;
  height:1px;
  background: rgba(255,255,255,0.10);
  pointer-events:none;
}

body.theme-light .s1-section{
  border:1px solid var(--border);
  background:#ffffff;
  box-shadow: 0 10px 18px rgba(2,6,23,0.06);
}
body.theme-light .s1-section::before{
  background: rgba(2,6,23,0.06);
}

.s1-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}

.s1-title{
  font-size:16px;
  font-weight:800;
  letter-spacing:-0.2px;
}

.s1-subtitle{
  margin: 10px 0 6px;
  font-size:13px;
  font-weight:800;
  color: var(--muted);
}

.s1-divider{
  height:1px;
  margin: 12px 0;
  opacity:1;
  background: rgba(148,163,184,0.22);
}
body.theme-light .s1-divider{
  background: var(--border);
}

/* ì…ë ¥ ì¤‘ ì„¹ì…˜ ê°•ì¡° */
.s1-section:focus-within{
  border-color: rgba(34,197,94,0.55);
  box-shadow:
    0 10px 22px rgba(0,0,0,0.28),
    0 0 0 2px rgba(34,197,94,0.18);
}

/* ë¼ë²¨ ìˆ¨ê¹€(ì ‘ê·¼ì„± ìœ ì§€) */
.sr-only{
  position:absolute !important;
  width:1px; height:1px;
  padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0);
  white-space:nowrap; border:0;
}

/* í°íŠ¸ ë²„íŠ¼: í°íŠ¸ ì°¨ì´ ì˜ ë³´ì´ê²Œ */
.title-font-toggle .toggle-btn,
.text-font-toggle .toggle-btn{
  min-height:44px;
  padding:0 8px;
  font-size:18px;
  line-height:1;
  display:flex;
  align-items:center;
  justify-content:center;
}

  /* âœ… h1 + step-navë¥¼ í•œ ë©ì–´ë¦¬ë¡œ ìƒë‹¨ ê³ ì • */
.sidebar-top{
  position: sticky;
  top: 0;
  z-index: 80;
  background: var(--sidebar-bg);
  padding: 12px 0 12px;
  border-bottom: 1px solid var(--border);
}

/* âœ… h1 ë†’ì´ ì¤„ì´ê¸° */
.sidebar-top h1{
  font-size: 18px;       /* 20 â†’ 18 */
  margin: 0 0 10px;      /* ìœ„ìª½ ì—¬ë°± ì œê±° */
  line-height: 1.1;
}

/* âœ… STEP íŒ¨ë„ ìŠ¤í¬ë¡¤ ì˜ì—­ */
.sidebar-scroll{
  flex:1 1 auto;
  overflow-y:auto;
  padding:12px 20px 18px;
  display:flex;
  flex-direction:column;
  gap:var(--ui-gap);
}

/* (ì„ íƒ) step-nav ìœ„/ì•„ë˜ ê°„ê²© ì •ë¦¬ */
.sidebar-top .step-nav{
  margin:8px 0 0;
}
    
/* Step3: 'ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ' ë²„íŠ¼ ìˆ¨ê¹€ */
#playBtn { display:none !important; }

    /* ===== record-mode: ì˜¤ë²„ìŠ¤í¬ë¡¤/í˜ì´ì§€ ìŠ¤í¬ë¡¤ íŠ ë°©ì§€ ===== */
body.record-mode, body.record-mode html {
  overscroll-behavior: none;
}

body.record-mode {
  touch-action: none;
}

body.record-mode .timeline-viewport {
  overscroll-behavior: none;
  /* ì•„ë˜ ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë•Œë¬¸ì— ë§ˆì§€ë§‰ í™”ë©´ì´ ê°€ë ¤ì§€ì§€ ì•Šê²Œ */
  padding-bottom: 170px;
}

/* ===== íƒ€ì´í‹€ í˜ì´ì§€ ë”¤ ì˜¤ë²„ë ˆì´ ===== */
#titlePageDimOverlay{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:9000; /* íƒ€ì´í‹€ í…ìŠ¤íŠ¸(9998) ì•„ë˜, ëŒ€ë¶€ë¶„ ìš”ì†Œ ìœ„ */
  background: rgba(0,0,0,0);
}

/* ===== record-mode í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ ===== */
.record-controls{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10001;
  padding: 12px 12px 16px;
  display: none;
  pointer-events: none;
}

/* record-controls: ê¸°ë³¸ ìˆ¨ê¹€ */
body.record-mode .record-controls{ display:none; }

/* âœ… Step2 + ì œëª© íƒ­ í”„ë¦¬ë·°ì—ì„œë§Œ í‘œì‹œ */
body.record-mode[data-step="2"][data-step2view="title"] .record-controls{
  display:block;
}

/* âœ… í•˜ë‹¨ record-controls ì¹´ë“œ: ì™„ì „ ìœ ë¦¬íŒ */
.record-controls .rc-card{
  background: rgba(2,6,23,0.25);     /* 0.45 -> 0.25 */
  border: 1px solid rgba(148,163,184,0.16);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
}

body.theme-light .record-controls .rc-card{
  background: rgba(249,250,251,0.35);
  border: 1px solid rgba(229,231,235,0.9);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
}

.record-controls .rc-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 6px;
}

.record-controls .rc-title{
  font-size: 12px;
  color: rgba(226,232,240,0.85);
}

.record-controls .rc-pill{
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.25);
  color: rgba(226,232,240,0.9);
  background: rgba(15,23,42,0.55);
}

.record-controls input[type="range"]{
  width: 100%;
}

/* recordExit ì•„ì´ì½˜ì€ ìš°ìƒë‹¨ ê³ ì • + í•­ìƒ ë³´ì´ê²Œ(ì›ë˜ë„ fixedì§€ë§Œ z-index ì˜¬ë¦¼) */
body.record-mode #recordExitBtn{
  z-index: 10002;
}

    /* âœ… range ì…ë ¥ì€ ê¸°ë³¸ input ìŠ¤íƒ€ì¼(íŒ¨ë”©/ë³´ë”/44px)ì´ ë„ˆë¬´ ì»¤ì„œ ë”°ë¡œ ì •ë¦¬ */
input[type="range"]{
  padding:0 !important;
  border:none !important;
  background:transparent !important;
  min-height:auto !important;
  height:28px;
}

/* âœ… Step2 ì œëª© ë°°ê²½ ìŠ¤íƒ€ì¼: â€œí•œ ì¤„ ì»¨íŠ¸ë¡¤â€ ë ˆì´ì•„ì›ƒ */
.fx-control{
  display:grid;
  grid-template-columns:auto 1fr auto;
  align-items:center;
  gap:10px;
  padding:8px 0;
}

.fx-label{
  font-size:13px;
  font-weight:800;
  letter-spacing:-0.2px;
  white-space:nowrap;
  color: rgba(226,232,240,0.85);
}
body.theme-light .fx-label{
  color: rgba(17,24,39,0.70);
}

.fx-range{ width:100%; }

.fx-badge{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.22);
  background: rgba(15,23,42,0.35);
  color: rgba(226,232,240,0.9);
  white-space:nowrap;
}
body.theme-light .fx-badge{
  background: rgba(15,23,42,0.08);
  color: rgba(17,24,39,0.75);
  border-color: rgba(229,231,235,1);
}

/* âœ… í•˜ë‹¨ record-controls ì¹´ë“œ: ë” â€œíˆ¬ëª…í•˜ê²Œâ€ */
.record-controls .rc-card{
  background: rgba(2,6,23,0.45); /* 0.72 -> 0.45 */
  border: 1px solid rgba(148,163,184,0.18);
}
body.theme-light .record-controls .rc-card{
  background: rgba(249,250,251,0.65);
  border: 1px solid rgba(229,231,235,0.9);
}

   /* âœ… record-controls ì•ˆì—ì„œë„ fx-controlê°€ ê¹”ë”í•˜ê²Œ ë³´ì´ê²Œ */
.record-controls .fx-label{
  color: rgba(226,232,240,0.88);
}
body.theme-light .record-controls .fx-label{
  color: rgba(17,24,39,0.72);
} 
    
</style>

</head>
<body class="theme-dark" data-step="1">
<div class="sidebar">



  
  <!-- âœ… ìƒë‹¨ ê³ ì • ì˜ì—­ (H1 + STEP NAV) -->
  <div class="sidebar-top">
    <h1>
      íƒ€ì„ë¼ì¸ ì—ë””í„°
      <button id="themeToggle" class="btn-theme">ë¼ì´íŠ¸ ëª¨ë“œ</button>
    </h1>

    <div class="step-nav">
      <button type="button" class="step-btn active" data-step="1">1. ì•„ì´í…œ ì¶”ê°€</button>
      <button type="button" class="step-btn" data-step="2">2. íƒ€ì„ë¼ì¸ í¸ì§‘</button>
      <button type="button" class="step-btn" data-step="3">3. ì• ë‹ˆë©”ì´ì…˜</button>
    </div>
    <div id="step2SubNav" class="step2-subnav" style="display:none;">
      <button type="button" class="sub-btn" data-view="title">ì˜ìƒ ì œëª©</button>
  <button type="button" class="sub-btn active" data-view="timeline">íƒ€ì„ë¼ì¸ í¸ì§‘</button>
  
</div>
  </div>

  <!-- âœ… ìŠ¤í¬ë¡¤ ì˜ì—­ (STEP íŒ¨ë„ë“¤ ì „ë¶€ ì—¬ê¸°ë¡œ) -->
  <div class="sidebar-scroll">

    <!-- STEP 1 -->
    <div id="step1Panel" class="step-panel active">
      <div class="step1-sections">

        <!-- 1) ë‚ ì§œ -->
        <section class="s1-section">
          <div class="s1-head">
            <div class="s1-title">ë‚ ì§œ</div>
          </div>

          <label class="sr-only" for="date">ë‚ ì§œ ì„ íƒ</label>
          <div class="row">
            <input type="date" id="date" />
            <button type="button" id="datePickerBtn" class="btn-secondary btn-date">ğŸ“…</button>
          </div>
        </section>

        <!-- 2) ì˜ìƒ ì œëª© -->
        <section class="s1-section">
          <div class="s1-head">
            <div class="s1-title">ì˜ìƒ ì œëª© (ì„ íƒ)</div>
          </div>

          <label class="sr-only" for="videoTitle">ì˜ìƒ ì œëª©</label>
          <input id="videoTitle" type="text" placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />

          <div class="title-font-toggle" id="titleFontToggle" aria-label="ì œëª© í°íŠ¸ ì„ íƒ" style="margin-top:10px;">
            <button type="button" class="toggle-btn active" data-font="pretendard">ì œëª©</button>
            <button type="button" class="toggle-btn" data-font="laudrygo">ì œëª©</button>
            <button type="button" class="toggle-btn" data-font="nanum">ì œëª©</button>
            <button type="button" class="toggle-btn" data-font="bagel">ì œëª©</button>
          </div>
          
<!-- âœ… ì œëª© ë°°ê²½ì‚¬ì§„(ì„ íƒ): íŒŒì¼ ì¶”ê°€ + íŒŒì¼ëª… í‘œì‹œ + ì‚­ì œ(X) -->
<div style="margin-top:12px;">
  <div class="row" style="gap:10px; align-items:center;">
    <div style="flex:1; font-weight:800; font-size:14px; letter-spacing:-0.2px;">
      ë°°ê²½ì‚¬ì§„(ì„ íƒ)
    </div>

    <button type="button" id="titleBgPickBtn" class="btn-secondary" style="flex:0 0 auto; width:auto;">
      íŒŒì¼ ì¶”ê°€
    </button>

    <input type="file" id="titleBgFile" accept="image/*" multiple style="display:none;" />
  </div>

  <div id="titleBgMeta"
       style="display:none; margin-top:8px; align-items:center; justify-content:space-between; gap:8px;">
    <span id="titleBgName"
          style="font-size:13px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
    </span>
    <button type="button" id="titleBgClearBtn" class="block-delete-btn" aria-label="ë°°ê²½ ì‚¬ì§„ ì‚­ì œ">âœ•</button>
  </div>
</div>

 
        </section>

        <!-- 3) ì•„ì´í…œ ì¶”ê°€ -->
        <section class="s1-section">
          <div class="s1-head">
            <div class="s1-title">ì•„ì´í…œ ì¶”ê°€</div>
          </div>

          <div class="s1-subtitle">ì‹œê°„ êµ¬ê°„(ì‹œì‘ ~ ë)</div>
          <div class="row">
            <select id="startTime"></select>
            <select id="endTime"></select>
          </div>

          <div class="s1-divider"></div>

          <div class="s1-subtitle">ì•„ì´í…œ íƒ€ì…</div>
          <div class="item-type-toggle">
            <button type="button" class="toggle-btn active" data-type="file">ì´ë¯¸ì§€/ë™ì˜ìƒ</button>
            <button type="button" class="toggle-btn" data-type="text">í…ìŠ¤íŠ¸</button>
          </div>

          <div id="textInputGroup" style="margin-top:10px;">
            <textarea id="textContent" placeholder="í…ìŠ¤íŠ¸ ì•„ì´í…œ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>

            <div class="text-font-toggle" id="textFontToggle" aria-label="í…ìŠ¤íŠ¸ í°íŠ¸ ì„ íƒ" style="margin-top:10px;">
              <button type="button" class="toggle-btn active" data-font="pretendard">í…ìŠ¤íŠ¸</button>
              <button type="button" class="toggle-btn" data-font="laudrygo">í…ìŠ¤íŠ¸</button>
              <button type="button" class="toggle-btn" data-font="nanum">í…ìŠ¤íŠ¸</button>
              <button type="button" class="toggle-btn" data-font="bagel">í…ìŠ¤íŠ¸</button>
            </div>
          </div>

          <div id="imageInputGroup" style="margin-top:10px;">
            <input type="file" id="imageFile" accept="image/*,video/*" />
          </div>

          <div class="s1-divider"></div>

          <button id="addItemBtn" class="btn-primary">ì•„ì´í…œ ì¶”ê°€</button>
          <p id="timeSummary" class="hint" style="margin-top:10px;">ì•„ì§ ì¶”ê°€ëœ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          <ul id="blockList" class="block-list"></ul>
        </section>

      </div>
    </div>

    <!-- STEP 2 -->
    <div id="step2Panel" class="step-panel">
      <p class="hint">
        íƒ€ì„ë¼ì¸ì—ì„œ ì•„ì´í…œì„ <b>ê¸¸ê²Œ ëˆ„ë¥´ë©´</b> í¸ì§‘ ëª¨ë“œë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.<br/>
        í¸ì§‘ ëª¨ë“œì—ì„œëŠ”:
      </p>
      <ul class="hint" style="margin: 8px 0; padding-left: 20px;">
        <li>í•œ ì†ê°€ë½ ë“œë˜ê·¸ë¡œ ììœ ë¡­ê²Œ ìœ„ì¹˜ ì´ë™</li>
        <li>ë‘ ì†ê°€ë½ í•€ì¹˜ë¡œ í¬ê¸° ì¡°ì ˆ</li>
        <li>ë‘ ì†ê°€ë½ íšŒì „ìœ¼ë¡œ ê°ë„ ì¡°ì ˆ</li>
      </ul>
      <p class="hint">
        ë¹ˆ ê³µê°„ì„ íƒ­í•˜ë©´ í¸ì§‘ ëª¨ë“œê°€ í•´ì œë©ë‹ˆë‹¤.<br/>
        ì•„ì´í…œë“¤ì´ ê²¹ì¹  ìˆ˜ ìˆìœ¼ë©°, í¸ì§‘í•˜ëŠ” ì•„ì´í…œì´ ê°€ì¥ ìœ„ì— í‘œì‹œë©ë‹ˆë‹¤.
      </p>
<!-- âœ… Step2: ì˜ìƒ ì œëª© ë°°ê²½ ìŠ¤íƒ€ì¼(ë¸”ëŸ¬/ë”¤) -->
<div id="step2TitleControls" style="display:none; margin-top:14px;">
  <div class="s1-section" style="padding:14px;">
    <div class="s1-head">
      <div class="s1-title">ì œëª© ë°°ê²½ ìŠ¤íƒ€ì¼</div>
    </div>

<div class="fx-control">
  <span class="fx-label">íë¦¬ê²Œ</span>
  <input class="fx-range" type="range" id="titleBlurRange" min="0" max="20" step="1" value="0" />
  <span id="titleBlurLabel" class="fx-badge">0px (OFF)</span>
</div>

<div class="fx-control">
  <span class="fx-label">ì–´ë‘¡ê²Œ</span>
  <input class="fx-range" type="range" id="titleDimRange" min="0" max="80" step="1" value="45" />
  <span id="titleDimLabel" class="fx-badge">45%</span>
</div>

    <p class="hint" style="margin-top:10px;">
      ë°°ê²½ ì‚¬ì§„ì´ ìˆì„ ë•Œë§Œ ëˆˆì— ë³´ì´ê²Œ ì ìš©ë¼ìš”.
    </p>
  </div>
</div>

      
    </div>

    <!-- STEP 3 -->
    <div id="step3Panel" class="step-panel">

      <div style="margin-top:8px;">
        <label>ì• ë‹ˆë©”ì´ì…˜ ëª¨ë“œ</label>
        <div class="animation-mode-toggle">
          <button type="button" class="toggle-btn active" data-mode="scroll">ìŠ¤í¬ë¡¤ë§Œ</button>
          <button type="button" class="toggle-btn" data-mode="scrollReveal">ìŠ¤í¬ë¡¤ + ìˆœì°¨ ë“±ì¥</button>
        </div>
      </div>

      <div style="margin-top: 8px;">
        <label>ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ ì‹œê°„ (ì „ì²´ ìŠ¤í¬ë¡¤ ì‹œê°„)</label>
        <div class="speed-row">
<input type="range" id="speed" min="3" max="55" step="1" value="30" />
<span id="speedLabel">30ì´ˆ</span>
        </div>
      </div>

      <button id="playBtn" class="btn-secondary">â–¶ ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ</button>
      <button id="playFullscreenBtn" class="btn-secondary">â›¶ ì „ì²´ í™”ë©´ ì¬ìƒ</button>

      <p class="hint">
        ì „ì²´ í™”ë©´ ì¬ìƒ í›„ íœ´ëŒ€í° í™”ë©´ ë…¹í™” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´<br/>
        íƒ€ì„ë¼ì¸ ì˜ìƒìœ¼ë¡œ ë°”ë¡œ ì €ì¥í•  ìˆ˜ ìˆì–´ìš”.
      </p>
    </div>

  </div>
</div>


  <div class="main">
    <div class="step1-placeholder">
      2ë‹¨ê³„ì—ì„œ íƒ€ì„ë¼ì¸ì„ í¸ì§‘í•  ìˆ˜ ìˆì–´ìš”.<br/>
      ë¨¼ì € 1ë‹¨ê³„ì—ì„œ ì•„ì´í…œì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
    </div>

<div class="timeline-viewport" id="viewport">
<!-- âœ… Step2 ì œëª© í”„ë¦¬ë·°ìš©: í•˜ë‹¨ ê³ ì • ë¸”ëŸ¬/ë”¤ ì»¨íŠ¸ë¡¤ -->
<div class="record-controls" id="titlePreviewControls" aria-label="ì œëª© í”„ë¦¬ë·° ì»¨íŠ¸ë¡¤">
  <div class="rc-card">

    <div class="fx-control">
      <span class="fx-label">íë¦¬ê²Œ</span>
      <input class="fx-range" type="range" id="pvBlurRange" min="0" max="20" step="1" value="0" />
    </div>

    <div class="fx-control" style="margin-top:8px;">
      <span class="fx-label">ì–´ë‘¡ê²Œ</span>
      <input class="fx-range" type="range" id="pvDimRange" min="0" max="80" step="1" value="45" />
    </div>

  </div>
</div>


  <!-- âœ… (ì¶”ê°€) ë…¹í™” ëª¨ë“œ(ê°€ì§œ ì „ì²´í™”ë©´) ì¢…ë£Œ ë²„íŠ¼ -->
  <button type="button" id="recordExitBtn" class="record-exit" aria-label="ë…¹í™” ëª¨ë“œ ì¢…ë£Œ">âœ•</button>
  
  <!-- (ì„ íƒ) í•˜ë‹¨ ê·¸ë¼ë°ì´ì…˜. 'ì‹œìŠ¤í…œ ì•ˆë‚´ë¬¸êµ¬'ëŠ” ëª» ê°€ë¦¬ì§€ë§Œ, UI ì—°ì¶œìš©ìœ¼ë¡œë§Œ ì‚¬ìš© -->
  <div class="fullscreen-mask"></div>

<div class="viewport-header" id="headerLabel">
  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
</div>

<!-- âœ… Step2 "ì˜ìƒ ì œëª©" ì „ìš© ë ˆì´ì–´(íƒ€ì„ë¼ì¸ ìˆ¨ê¸°ê³  ì—¬ê¸°ì„œ í¸ì§‘) -->
<div class="title-page-layer" id="titlePageLayer"></div>

<div class="timeline-title-overlay" id="titleOverlay"></div>
<div class="timeline-inner" id="timeline"></div>
</div>

  <script>
(() => {
  /* ================================
     Timeline Story Editor v2.1 (CLEAN)
     - ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ / JS ì •ë¦¬
     ================================ */

  /* ---------- Constants ---------- */
  const HOUR_HEIGHT = 120;
  const MINUTE_PX = HOUR_HEIGHT / 60;
  const TOTAL_HOURS = 48;
  const MAX_MINUTES = TOTAL_HOURS * 60;
  const MIN_ITEM_HEIGHT = 100;

  /* ---------- DOM ---------- */
  const timeline = document.getElementById('timeline');
  const viewport = document.getElementById('viewport');
  const headerLabel = document.getElementById('headerLabel');
  const titleOverlay = document.getElementById('titleOverlay');
  const titlePageLayer = document.getElementById('titlePageLayer');
  
  const dateInput = document.getElementById('date');
  const datePickerBtn = document.getElementById('datePickerBtn');

  const startTimeSelect = document.getElementById('startTime');
  const endTimeSelect = document.getElementById('endTime');

  const textContentInput = document.getElementById('textContent');
  const imageFileInput = document.getElementById('imageFile');
  const textInputGroup = document.getElementById('textInputGroup');
  const imageInputGroup = document.getElementById('imageInputGroup');

  const addItemBtn = document.getElementById('addItemBtn');
  const timeSummaryEl = document.getElementById('timeSummary');
  const blockListEl = document.getElementById('blockList');

  const themeToggleBtn = document.getElementById('themeToggle');

  const speedInput = document.getElementById('speed');
  const speedLabel = document.getElementById('speedLabel');
  const playBtn = document.getElementById('playBtn');
  const playFullscreenBtn = document.getElementById('playFullscreenBtn');
  const videoTitleInput = document.getElementById('videoTitle');
  
    // âœ… Title BG DOM
  const titleBgPickBtn = document.getElementById('titleBgPickBtn');
  const titleBgFile = document.getElementById('titleBgFile');
  const titleBgMeta = document.getElementById('titleBgMeta');
  const titleBgName = document.getElementById('titleBgName');
  const titleBgClearBtn = document.getElementById('titleBgClearBtn');

  // âœ… Step2 ì œëª© ë°°ê²½ ìŠ¤íƒ€ì¼ ì»¨íŠ¸ë¡¤
  const step2TitleControls = document.getElementById('step2TitleControls');
  const titleBlurRange = document.getElementById('titleBlurRange');
  const titleBlurLabel = document.getElementById('titleBlurLabel');
  const titleDimRange = document.getElementById('titleDimRange');
  const titleDimLabel = document.getElementById('titleDimLabel');

 // âœ… Preview Controls DOM (í•˜ë‹¨ ê³ ì •)
const pvBlurRange = document.getElementById('pvBlurRange');
const pvDimRange  = document.getElementById('pvDimRange');
const pvBlurPill  = document.getElementById('pvBlurPill');
const pvDimPill   = document.getElementById('pvDimPill');

function syncPreviewControlsFromState(){
  if (!pvBlurRange || !pvDimRange) return;
  const b = clamp(Number(titleBgBlurPx || 0), 0, 20);
  const d = clamp(Number(titleBgDimPct || 45), 0, 80);

  pvBlurRange.value = String(b);
  pvDimRange.value = String(d);

  pvBlurPill.textContent = (b === 0) ? '0px (OFF)' : (b + 'px');
  pvDimPill.textContent = d + '%';
}

  
  const stepButtons = document.querySelectorAll('.step-btn');
  const step2SubNav = document.getElementById('step2SubNav');
  const itemTypeButtons = document.querySelectorAll('.item-type-toggle .toggle-btn');
  const animationModeButtons = document.querySelectorAll('.animation-mode-toggle .toggle-btn');

  const stepPanels = {
    1: document.getElementById('step1Panel'),
    2: document.getElementById('step2Panel'),
    3: document.getElementById('step3Panel')
  };

  /* ---------- Title Font Toggle ---------- */
  const titleFontButtons = document.querySelectorAll('#titleFontToggle .toggle-btn');
  let currentTitleFont = localStorage.getItem('titleFont') || 'pretendard';

  function applyTitleFont(fontKey){
    titleFontButtons.forEach(b => b.classList.toggle('active', b.dataset.font === fontKey));
    currentTitleFont = fontKey;
    localStorage.setItem('titleFont', fontKey);

    titleOverlay.classList.remove('titlefont-bagel','titlefont-nanum','titlefont-pretendard','titlefont-laudrygo');
    titleOverlay.classList.add(`titlefont-${fontKey}`);
    if (titleItem) {
  titleItem.fontKey = fontKey;
  applyTitleItemStyles();
}
    markDirtyAndSave('titleFont');
  }

  titleFontButtons.forEach(btn => {
    btn.addEventListener('click', () => applyTitleFont(btn.dataset.font));
  });




  /* ---------- Text Font Toggle ---------- */
  const textFontButtons = document.querySelectorAll('#textFontToggle .toggle-btn');
  let currentTextFont = localStorage.getItem('textFont') || 'pretendard';

  function applyTextFont(fontKey){
    textFontButtons.forEach(b => b.classList.toggle('active', b.dataset.font === fontKey));
    currentTextFont = fontKey;
    localStorage.setItem('textFont', fontKey);
    markDirtyAndSave('textFont');
  }

  textFontButtons.forEach(btn => {
    btn.addEventListener('click', () => applyTextFont(btn.dataset.font));
  });
  

  /* ---------- State ---------- */
  let currentItemType = 'file';
  let currentAnimationMode = 'scroll';

  let blocks = [];
  let items = [];

  let titleItem = null;
let titleItemEl = null;
  // âœ… ì œëª© ìœ„ì¹˜ë¥¼ ì‚¬ìš©ìê°€ ì˜®ê²¼ëŠ”ì§€
let titleItemUserMoved = false;

  let titleBgDataUrl = null;        // base64 (ë³µì›ìš©)
let titleBgBlurPx = 0;            // 0ì´ë©´ OFF
let titleBgDimPct = 45;           // 0~80
  
  let editingItemEl = null;
  let animFrameId = null;

  // gesture
  let activeTouches = [];
  let gestureState = null;

  let longPressTimer = null;
  let longPressStartPos = null;
  let zCounter = 1;

  let step2View = 'timeline'; // 'timeline' | 'title'

  let titleBgList = [];          // âœ… ì—¬ëŸ¬ ì¥ ì§€ì›: [dataUrl, dataUrl, ...]
let titleBgItem = null;        // ë©”ì¸ ë°°ê²½ ì•„ì´í…œ state
let titleBgItemEl = null;      // ë©”ì¸ ë°°ê²½ DOM
  
function hasVideoTitle(){
  return !!(videoTitleInput.value && videoTitleInput.value.trim());
}

function setStep2View(next){
  step2View = next;

  // âœ… CSS ì œì–´ìš©
  document.body.dataset.step2view = next;

  // ë²„íŠ¼ active ì²˜ë¦¬
  step2SubNav.querySelectorAll('.sub-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.view === next);
  });
if (next === 'title') {
  // âœ… ì œëª© íƒ­ = ê³§ë°”ë¡œ í”„ë¦¬ë·°(ê°€ì§œ ì „ì²´í™”ë©´)
  enterRecordMode('titlePreview');

  titlePageLayer.style.display = 'block';

  ensureTitleItem();
  ensureTitleBgItem();

  // âœ… â€œë¸”ëŸ¬/ë”¤ ì ìš© ì•ˆ ë¨â€ íƒ€ì´ë° ë°©ì§€: ë°°ê²½ ìš”ì†Œ ìƒì„± í›„ í•œ ë²ˆ ë” ë°˜ì˜
  applyTitleBgToTitlePage();

  showTitleItem(true);
  showTitleBgItem(true);

 // âœ… ì²˜ìŒ ì§„ì… ë•Œë§Œ ì¤‘ì•™ì •ë ¬ (ì‚¬ìš©ìê°€ ì˜®ê²¼ìœ¼ë©´ ìœ ì§€)
if (!titleItemUserMoved) centerTitleItemInViewport();
  syncPreviewControlsFromState();
  exitEditMode();
} else {
  // âœ… ì œëª© íƒ­ ë²—ì–´ë‚˜ë©´ í”„ë¦¬ë·° ì¢…ë£Œ
  if (document.body.classList.contains('record-mode') && recordModeReason === 'titlePreview') {
    exitRecordMode();
  }

  titlePageLayer.style.display = 'none';
  showTitleItem(false);
  showTitleBgItem(false);
}

  updateStep2TitleControlsVisibility();
}


function updateStep2SubNavVisibility(){
  const isStep2 = document.body.dataset.step === '2';
  const show = isStep2 && hasVideoTitle();

  step2SubNav.style.display = show ? 'flex' : 'none';

  // ì œëª©ì´ ì—†ì–´ì¡Œìœ¼ë©´ ê°•ì œë¡œ timelineë¡œ ë³µê·€ + ì œëª© ìˆ¨ê¹€
  if (!show) {
    step2View = 'timeline';
    showTitleItem(false);
  } else {
    // step2 ë“¤ì–´ì™”ëŠ”ë° ì„œë¸Œíƒ­ ë³´ì´ë©´ ê¸°ë³¸ì€ íƒ€ì„ë¼ì¸(ì›ë˜ íë¦„ ìœ ì§€)
    setStep2View(step2View || 'timeline');
  }
}

  
  /* ---------- Utils ---------- */
 function minutesToTimeLabel(totalMinutes) {
  const isNext = totalMinutes >= 1440;
  let m = totalMinutes;
  if (isNext) m -= 1440;

  const h = Math.floor(m / 60);
  const mm = m % 60;

  const hh = String(h).padStart(2,'0');
  const mmStr = String(mm).padStart(2,'0');
  const base = `${hh}:${mmStr}`;

  return isNext ? `+1ì¼ ${base}` : base;
}

  function clamp(n, min, max){ return Math.max(min, Math.min(n, max)); }

  function formatDateYYYYMMDD(dt){
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const d = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

function getDatePlusDays(baseYYYYMMDD, days){
  if (!baseYYYYMMDD) return '';
  const [y, m, d] = baseYYYYMMDD.split('-').map(Number);
  const dt = new Date(y, (m-1), d); // âœ… ë¡œì»¬ ì•ˆì • íŒŒì‹±
  dt.setDate(dt.getDate() + days);
  return formatDateYYYYMMDD(dt);
}

function updateHeaderDateByScroll(scrollTop){
  const base = dateInput.value || '';
  if (!base) return;

  const viewportHeight = viewport.clientHeight;
  const centerY = scrollTop + viewportHeight/2;
  const minutes = centerY / MINUTE_PX;

  const dayIndex = Math.floor(minutes / 1440); // 0: ì˜¤ëŠ˜, 1: +1ì¼
  const clampedDay = clamp(dayIndex, 0, 1);

  const dateStr = getDatePlusDays(base, clampedDay);
  headerLabel.textContent = dateStr + ' íƒ€ì„ë¼ì¸';
}
function fitTextBoxToContent(el, item, maxW){
  const t = el.querySelector('.timeline-item-text');
  if (!t) return;

  // âœ… ìµœëŒ€ í­(ëª¨ë°”ì¼ ê¸°ì¤€ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šê²Œ)
  const limitW = maxW || Math.max(160, viewport.clientWidth - 80);

  // ì¸¡ì • ì „: ìì—° í¬ê¸° + ì¤„ë°”ê¿ˆ í—ˆìš© + ìµœëŒ€í­ ì œí•œ
  t.style.width = 'max-content';
  t.style.maxWidth = limitW + 'px';
  t.style.height = 'auto';

  // ë ˆì´ì•„ì›ƒ ë°˜ì˜ í›„ ì‹¤ì œ í¬ê¸° ì½ê¸°
  requestAnimationFrame(() => {
    const rect = t.getBoundingClientRect();

    // í„°ì¹˜ ê°€ëŠ¥í•œ ìµœì†Œ í¬ê¸° ë³´ì¥
    const newW = clamp(Math.ceil(rect.width), 80, limitW);
    const newH = clamp(Math.ceil(rect.height), 44, 2000);

    el.style.width = newW + 'px';
    el.style.height = newH + 'px';

    item.w = newW;
    item.h = newH;
  });
}
  
    /* ---------- Save: ì¦‰ì‹œ ì €ì¥ + 3ë¶„ ë°±ì—… ì €ì¥ ---------- */
  const STORAGE_KEY = 'tse_v21_state';
  const BACKUP_SAVE_MS = 180000; // 3ë¶„ (ìœ ì§€)

  let backupSaveTimer = null;

  function getStateSnapshot() {
  return {
    v: '2.1',
    savedAt: Date.now(),
    date: dateInput.value || '',
    title: videoTitleInput.value || '',
    currentTitleFont,
    currentTextFont,
    currentItemType,
currentAnimationMode,
speedSec: Number(speedInput.value) || 30,
theme: document.body.classList.contains('theme-light') ? 'light' : 'dark', 
blocks,
    items,
     titleBg: {
  list: titleBgList,          // âœ… ë©€í‹° ìš°ì„ 
  dataUrl: titleBgDataUrl,    // âœ… êµ¬ë²„ì „/í˜¸í™˜ìš©
  blurPx: titleBgBlurPx,
  dimPct: titleBgDimPct
},

    ui: {
      step: document.body.dataset.step || '1',
      step2View,
      scrollTop: viewport.scrollTop || 0
    }
  };

}

  

  function saveStateNow(reason = '') {
    try {
      const snap = getStateSnapshot();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(snap));
      // í•„ìš”í•˜ë©´ ë””ë²„ê·¸ìš©:
      // console.log('[SAVE NOW]', reason, new Date().toLocaleTimeString());
    } catch (err) {
      console.warn('saveStateNow failed:', err);
    }
  }

  // ì•¡ì…˜ì´ ë°œìƒí•˜ë©´: 1) ì¦‰ì‹œ ì €ì¥  2) 3ë¶„ ë’¤ ë°±ì—… ì €ì¥ ì˜ˆì•½(ë¦¬ì…‹)
  function markDirtyAndSave(reason = '') {
    if (isRestoring) return; // âœ… ë³µì› ì¤‘ ì €ì¥ ë°©ì§€
    // 1) ì¦‰ì‹œ ì €ì¥
    saveStateNow(reason);

    // 2) 3ë¶„ ë°±ì—… ì €ì¥ ì˜ˆì•½ (ê¸°ì¡´ 3ë¶„ ìœ ì§€)
    if (backupSaveTimer) clearTimeout(backupSaveTimer);
    backupSaveTimer = setTimeout(() => {
      saveStateNow('backup(3min)');
      backupSaveTimer = null;
    }, BACKUP_SAVE_MS);
  }

  let isRestoring = false; // âœ… ë³µì› ì¤‘ì—” ì €ì¥ í˜¸ì¶œ ë§‰ê¸°

  /* ---------- Restore (ìƒˆë¡œê³ ì¹¨ ë³µì›) ---------- */
function setActiveByDataset(buttons, key, value){
  buttons.forEach(b => b.classList.toggle('active', b.dataset[key] === value));
}

function applyTitleFontUI(fontKey){
  // ë²„íŠ¼ active
  titleFontButtons.forEach(b => b.classList.toggle('active', b.dataset.font === fontKey));
  // overlay class
  titleOverlay.classList.remove('titlefont-bagel','titlefont-nanum','titlefont-pretendard','titlefont-laudrygo');
  titleOverlay.classList.add(`titlefont-${fontKey}`);
}
    

function applyTextFontUI(fontKey){
  textFontButtons.forEach(b => b.classList.toggle('active', b.dataset.font === fontKey));
}

function applyItemTypeUI(typeKey){
  currentItemType = typeKey;
  setActiveByDataset(itemTypeButtons, 'type', typeKey);

  if (typeKey === 'text') {
    textInputGroup.style.display = 'block';
    imageInputGroup.style.display = 'none';
  } else {
    textInputGroup.style.display = 'none';
    imageInputGroup.style.display = 'block';
  }
}

function applyAnimationModeUI(modeKey){
  currentAnimationMode = modeKey;
  setActiveByDataset(animationModeButtons, 'mode', modeKey);
}

function rebuildFromState(loadedBlocks, loadedItems){
  // 1) ê¸°ì¡´ DOM/ìƒíƒœ ì´ˆê¸°í™”
  blocks = [];
  items = [];
  editingItemEl = null;
  stopAnimation();
  clearHourHighlight();
  exitEditMode();

  while (timeline.firstChild) timeline.removeChild(timeline.firstChild);
  timeline.style.height = (TOTAL_HOURS * HOUR_HEIGHT) + 'px';

  buildHourGrid();
  buildDayBoundary();

  // 2) ë¸”ë¡ DOM ì¬êµ¬ì„± (+ element í¬ì¸í„° ë¶™ì´ê¸°)
  loadedBlocks = Array.isArray(loadedBlocks) ? loadedBlocks : [];
  loadedBlocks.forEach(b => {
    const top = b.startMinutes * MINUTE_PX;
    const height = (b.endMinutes - b.startMinutes) * MINUTE_PX;

    const blockEl = document.createElement('div');
    blockEl.className = 'time-block';
    blockEl.style.top = top + 'px';
    blockEl.style.height = height + 'px';
    blockEl.dataset.id = b.id;

    const inner = document.createElement('div');
    inner.className = 'time-block-inner';
    blockEl.appendChild(inner);
    timeline.appendChild(blockEl);

    blocks.push({
      id: b.id,
      startMinutes: b.startMinutes,
      endMinutes: b.endMinutes,
      duration: b.duration || (b.endMinutes - b.startMinutes),
      element: blockEl
    });
  });

  // 3) ì•„ì´í…œ DOM ì¬êµ¬ì„±
  loadedItems = Array.isArray(loadedItems) ? loadedItems : [];

  // title-itemì€ ë”°ë¡œ í•¸ë“¤ë§(viewportì— ë¶™ëŠ” êµ¬ì¡°ë‹ˆê¹Œ)
  titleItem = loadedItems.find(it => it && it.id === 'title-item') || null;
  titleItemEl = null;

  // ì¼ë°˜ ì•„ì´í…œë“¤
  loadedItems
  .filter(it => {
    if (!it) return false;
    if (it.id === 'title-item') return false;
    if (it.id === 'title-bg-item') return false;
    if (String(it.id).startsWith('title-bg-extra-')) return false;
    return true;
  })
  .forEach(it => {
    items.push(it);
    createItemElement(it);
  });


  // íƒ€ì´í‹€ ì•„ì´í…œ ë³µì›(ìˆìœ¼ë©´)
  if (titleItem) {
    // ensureTitleItem()ëŠ” items.push(titleItem)ì„ í•  ìˆ˜ ìˆìœ¼ë‹ˆ, ì¤‘ë³µ ë°©ì§€ìš©ìœ¼ë¡œ ì§ì ‘ ì„¸íŒ…
    // itemsì—ëŠ” titleItemë„ ìœ ì§€ë˜ë„ë¡ ë„£ì–´ë‘”ë‹¤
    const already = items.find(x => x.id === 'title-item');
    if (!already) items.push(titleItem);

    if (titleBgDataUrl) titleBgName.textContent = 'ë³µì›ëœ ë°°ê²½ì‚¬ì§„';
    // viewportì— íƒ€ì´í‹€ ì•„ì´í…œ ìƒì„±/ì ìš©
    ensureTitleItem();
  }

  updateTimeSummary();
}

function loadStateAndRestore(){
  let raw = null;
  try {
    raw = localStorage.getItem(STORAGE_KEY);
  } catch (e) {}
  if (!raw) return false;

  let snap = null;
  try {
    snap = JSON.parse(raw);
  } catch (e) {
    return false;
  }
  if (!snap || snap.v !== '2.1') return false;

  isRestoring = true;
  try {
    // ê°’ ì ìš©
    if (snap.date) dateInput.value = snap.date;
    if (typeof snap.title === 'string') videoTitleInput.value = snap.title;

    currentTitleFont = snap.currentTitleFont || currentTitleFont;
    currentTextFont  = snap.currentTextFont  || currentTextFont;

    applyTitleFontUI(currentTitleFont);
    applyTextFontUI(currentTextFont);

    applyItemTypeUI(snap.currentItemType || currentItemType);
    applyAnimationModeUI(snap.currentAnimationMode || currentAnimationMode);

    // âœ… speed ë³µì›
if (typeof snap.speedSec === 'number' && !Number.isNaN(snap.speedSec)) {
  speedInput.value = String(clamp(Math.round(snap.speedSec), 3, 55));
  speedLabel.textContent = speedInput.value + 'ì´ˆ';
} else {
  // í˜¹ì‹œ ê°’ ì—†ìœ¼ë©´ í˜„ì¬ ê°’ ê¸°ì¤€ìœ¼ë¡œ ë¼ë²¨ë§Œ ì •ë¦¬
  speedLabel.textContent = speedInput.value + 'ì´ˆ';
}
 // âœ… theme ë³µì›
if (snap.theme === 'light') {
  document.body.classList.remove('theme-dark');
  document.body.classList.add('theme-light');
  themeToggleBtn.textContent = 'ë‹¤í¬ ëª¨ë“œ';
} else {
  document.body.classList.remove('theme-light');
  document.body.classList.add('theme-dark');
  themeToggleBtn.textContent = 'ë¼ì´íŠ¸ ëª¨ë“œ';
}

    // âœ… titleBg ë³µì›
// âœ… titleBg ë³µì› (list ìš°ì„  + êµ¬ë²„ì „ dataUrl fallback)
if (snap.titleBg) {
  titleBgList = Array.isArray(snap.titleBg.list) ? snap.titleBg.list : [];

  // âœ… list[0] ìš°ì„ , ì—†ìœ¼ë©´ êµ¬ë²„ì „ dataUrl
  titleBgDataUrl = titleBgList[0] || snap.titleBg.dataUrl || null;

  titleBgBlurPx  = Number(snap.titleBg.blurPx || 0);     // 0ì´ë©´ OFF
  titleBgDimPct  = Number(snap.titleBg.dimPct || 45);

  // UI ë°˜ì˜
  refreshTitleBgMetaUI();
  applyTitleBgToOverlay();

  // âœ… íƒ€ì´í‹€ í˜ì´ì§€ ì•„ì´í…œ ë°˜ì˜(ë©”ì¸ + ì¶”ê°€ í©ë¿Œë¦¬ê¸°)
  // (í•¨ìˆ˜ë“¤ì´ ì´ë¯¸ ì¶”ê°€ë¼ ìˆë‹¤ëŠ” ì „ì œ)
  ensureTitleBgItem();
  scatterExtraTitleBgItems(titleBgList.slice(1));

  // ë¸”ëŸ¬ UI (0px = OFF)
  titleBlurRange.value = String(clamp(titleBgBlurPx, 0, 20));
  titleBlurLabel.textContent =
    (clamp(titleBgBlurPx, 0, 20) === 0) ? '0px (OFF)' : (clamp(titleBgBlurPx, 0, 20) + 'px');

  // ë”¤ UI
  titleDimRange.value = String(clamp(titleBgDimPct, 0, 80));
  titleDimLabel.textContent = clamp(titleBgDimPct, 0, 80) + '%';

  updateStep2TitleControlsVisibility();
} else {
  // snapì— titleBgê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì •ë¦¬
  titleBgList = [];
  titleBgDataUrl = null;
  titleBgBlurPx  = 0;
  titleBgDimPct  = 45;

  refreshTitleBgMetaUI();
  applyTitleBgToOverlay();

  titleBlurRange.value = '0';
  titleBlurLabel.textContent = '0px (OFF)';
  titleDimRange.value = '45';
  titleDimLabel.textContent = '45%';

  updateStep2TitleControlsVisibility();
}


    // íƒ€ì„ë¼ì¸/ë¸”ë¡/ì•„ì´í…œ ë³µì›
    rebuildFromState(snap.blocks, snap.items);

    // í—¤ë” ë‚ ì§œ ë°˜ì˜
    if (dateInput.value) {
      headerLabel.textContent = dateInput.value + ' íƒ€ì„ë¼ì¸';
      updateHeaderDateByScroll(viewport.scrollTop);
    }

    // step2 ì„œë¸Œíƒ­ ë…¸ì¶œ ì¡°ê±´ ë°˜ì˜
    updateStep2SubNavVisibility();

    // (ì„ íƒ) UI ìƒíƒœ ë³µì›
    if (snap.ui) {
      const step = snap.ui.step || '1';
      document.body.dataset.step = step;
      updateStep2TitleControlsVisibility();
      
      // step ë²„íŠ¼/íŒ¨ë„ active ë§ì¶”ê¸°
      stepButtons.forEach(b => b.classList.toggle('active', b.dataset.step === step));
      Object.entries(stepPanels).forEach(([k,p])=>{
        p.classList.toggle('active', k === step);
      });

      // step2View ë³µì›(ê°€ëŠ¥í•  ë•Œë§Œ)
      if (typeof snap.ui.step2View === 'string') {
        step2View = snap.ui.step2View;
        updateStep2SubNavVisibility();
        if (document.body.dataset.step === '2' && hasVideoTitle()) {
          setStep2View(step2View);
        }
      }

      // ìŠ¤í¬ë¡¤ ë³µì›
      if (typeof snap.ui.scrollTop === 'number') {
        viewport.scrollTop = snap.ui.scrollTop;
        highlightHourByScroll(viewport.scrollTop);
      }
    }

  } finally {
    isRestoring = false;
  }

  return true;
}
  
  /* ---------- Block / List ---------- */
  function updateBlockList() {
    blockListEl.innerHTML = '';
    if (!blocks.length) return;

    const sorted = blocks.slice().sort((a,b)=>a.startMinutes - b.startMinutes);

    sorted.forEach(b => {
      const li = document.createElement('li');
      li.dataset.blockId = b.id;

      const timeSpan = document.createElement('span');
      timeSpan.className = 'time';
      timeSpan.textContent =
        minutesToTimeLabel(b.startMinutes) + ' ~ ' + minutesToTimeLabel(b.endMinutes);

      const countSpan = document.createElement('span');
      countSpan.className = 'count';
      countSpan.textContent = `ì•„ì´í…œ ${items.filter(it => it.blockId === b.id).length}ê°œ`;

      const delBtn = document.createElement('button');
      delBtn.className = 'block-delete-btn';
      delBtn.textContent = 'âœ•';
      delBtn.addEventListener('click', ev => {
        ev.stopPropagation();
        if (confirm('ì´ ì‹œê°„ ë¸”ë¡ ì „ì²´ë¥¼ ì‚­ì œí• ê¹Œìš”?')) deleteBlockById(b.id);
      });

      const rightGroup = document.createElement('div');
      rightGroup.className = 'block-right-group';
      rightGroup.appendChild(countSpan);
      rightGroup.appendChild(delBtn);

      li.appendChild(timeSpan);
      li.appendChild(rightGroup);

      li.addEventListener('click', () => scrollToBlock(b.id));
      blockListEl.appendChild(li);
    });
  }

  function updateTimeSummary() {
    if (!blocks.length) {
      timeSummaryEl.textContent = 'ì•„ì§ ì¶”ê°€ëœ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.';
      blockListEl.innerHTML = '';
      return;
    }
    timeSummaryEl.textContent = `ì¶”ê°€ëœ ì‹œê°„ ë¸”ë¡: ${blocks.length}ê°œ`;
    updateBlockList();
  }

  function scrollToBlock(blockId) {
    const block = blocks.find(b => b.id === blockId);
    if (!block || !block.element) return;

    const blockTop = parseFloat(block.element.style.top) || 0;
    const blockHeight = block.element.offsetHeight || 0;

    const viewportHeight = viewport.clientHeight;
    const maxScroll = Math.max(0, timeline.scrollHeight - viewportHeight);

    let target = blockTop - (viewportHeight - blockHeight) / 2;
    target = clamp(target, 0, maxScroll);

    viewport.scrollTo({ top: target, behavior: 'smooth' });

    block.element.classList.add('highlight');
    setTimeout(()=>block.element.classList.remove('highlight'), 800);
  }

  function deleteBlockById(blockId) {
    const block = blocks.find(b => b.id === blockId);
    if (!block) return;

    const blockItems = items.filter(it => it.blockId === blockId);
    blockItems.forEach(it => {
      const el = timeline.querySelector(`.timeline-item[data-id="${it.id}"]`);
      if (el && el.parentElement) el.parentElement.removeChild(el);
    });

    items = items.filter(it => it.blockId !== blockId);

    if (block.element && block.element.parentElement) {
      block.element.parentElement.removeChild(block.element);
    }
    blocks = blocks.filter(b => b.id !== blockId);

    editingItemEl = null;
    updateTimeSummary();
     markDirtyAndSave('deleteBlock');
  }

  /* ---------- Time Options ---------- */
  function updateEndTimeOptions(startMinutes) {
    endTimeSelect.innerHTML = '';
    const minEnd = startMinutes + 30;
    for (let m=minEnd; m<=MAX_MINUTES; m+=30) {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = minutesToTimeLabel(m);
      endTimeSelect.appendChild(opt);
    }
  }

  function buildTimeOptions() {
    startTimeSelect.innerHTML = '';
    for (let m=0; m<=MAX_MINUTES-30; m+=30) {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = minutesToTimeLabel(m);
      if (m===7*60) opt.selected = true;
      startTimeSelect.appendChild(opt);
    }
    updateEndTimeOptions(parseInt(startTimeSelect.value,10));
  }

  /* ---------- Grid ---------- */
function buildHourGrid() {
  for (let h=0; h<TOTAL_HOURS; h++) {
    const top = h * HOUR_HEIGHT;

    const label = document.createElement('div');
    label.className = 'hour-label';
    label.style.top = (top + 8) + 'px';

    // âœ… Bì•ˆ: ì˜¤ëŠ˜ì€ 00~23, ë‹¤ìŒë‚ ì€ "+1ì¼ 00~23"
    const hourInDay = h % 24;
    const hh = String(hourInDay).padStart(2,'0');
    label.textContent = (h >= 24) ? `+1ì¼ ${hh}` : hh;

    const line = document.createElement('div');
    line.className = 'hour-line';
    line.style.top = (top + 28) + 'px';

    const half = document.createElement('div');
    half.className = 'half-line';
    half.style.top = (top + HOUR_HEIGHT/2 + 28) + 'px';

    timeline.appendChild(label);
    timeline.appendChild(line);
    timeline.appendChild(half);
  }
}

  function buildDayBoundary(){
  const base = dateInput.value || '';
  if (!base) return;

  const boundaryTop = 24 * HOUR_HEIGHT;

  const wrap = document.createElement('div');
  wrap.className = 'day-boundary';
  wrap.style.top = boundaryTop + 'px';

  const line = document.createElement('div');
  line.className = 'day-boundary-line';
  line.style.top = '0px';

  const label = document.createElement('div');
  label.className = 'day-boundary-label';
  label.textContent = getDatePlusDays(base, 1); // âœ… ë‹¤ìŒë‚  ë‚ ì§œ

  wrap.appendChild(line);
  wrap.appendChild(label);
  timeline.appendChild(wrap);
}


  function clearHourHighlight() {
    document.querySelectorAll('.hour-label').forEach(l => l.classList.remove('active'));
  }

  function highlightHourByScroll(scrollTop) {
    const viewportHeight = viewport.clientHeight;
    const centerY = scrollTop + viewportHeight/2;
    const minutes = centerY / MINUTE_PX;
    const hourIndex = Math.floor(minutes/60);

    clearHourHighlight();

    const labels = document.querySelectorAll('.hour-label');
    if (hourIndex>=0 && hourIndex<labels.length) labels[hourIndex].classList.add('active');

      // âœ… ì¶”ê°€: ìŠ¤í¬ë¡¤ ìœ„ì¹˜ì— ë”°ë¼ header ë‚ ì§œ ìë™ ë³€ê²½
  updateHeaderDateByScroll(scrollTop);
  }

  function resetTimelineDataAndDom() {
    blocks = [];
    items = [];
    editingItemEl = null;
    stopAnimation();
    clearHourHighlight();
    exitEditMode();

    while (timeline.firstChild) timeline.removeChild(timeline.firstChild);
    timeline.style.height = (TOTAL_HOURS*HOUR_HEIGHT)+'px';

    buildHourGrid();
    buildDayBoundary();
    updateTimeSummary();
  }

  /* ---------- Blocks ---------- */
  function getOrCreateBlock(startMinutes,endMinutes){
    const blockId = `block-${startMinutes}-${endMinutes}`;
    let block = blocks.find(b=>b.id===blockId);
    if (block) return block;

    const top = startMinutes * MINUTE_PX;
    const height = (endMinutes-startMinutes) * MINUTE_PX;

    const blockEl = document.createElement('div');
    blockEl.className='time-block';
    blockEl.style.top = top+'px';
    blockEl.style.height = height+'px';
    blockEl.dataset.id = blockId;

    const inner = document.createElement('div');
    inner.className='time-block-inner';
    blockEl.appendChild(inner);
    timeline.appendChild(blockEl);

    block = {id:blockId,startMinutes,endMinutes,duration:endMinutes-startMinutes,element:blockEl};
    blocks.push(block);
    updateTimeSummary();
    return block;
  }

  /* ---------- Items ---------- */
  function getItemByElement(el){
    const id=el.dataset.id;
    return items.find(it=>it.id===id);
  }

  function createItemElement(item) {
    const el = document.createElement('div');
    el.className = 'timeline-item';
    el.dataset.id = item.id;
    el.style.left = item.x + 'px';
    el.style.top = item.y + 'px';
    el.style.width = item.w + 'px';
    el.style.height = item.h + 'px';
    el.style.transform = `rotate(${item.rotation || 0}rad)`;
    el.dataset.rotation = item.rotation || 0;
    el.style.zIndex = (++zCounter).toString();

    if (item.type === 'image') {
      const img = document.createElement('img');
      img.src = item.src;
      img.style.objectFit = 'contain';
      el.appendChild(img);
    } else if (item.type === 'video') {
      const v = document.createElement('video');
      v.src = item.src;
      v.muted = true;
      v.loop = true;
      v.autoplay = true;
      v.playsInline = true;
      v.style.objectFit = 'contain';
      el.appendChild(v);
    } else {
      const t = document.createElement('div');
      t.className = 'timeline-item-text';
      t.textContent = item.text;

      const fontMap = {
        pretendard: '"PretendardSemiBoldLocal","Pretendard",system-ui,sans-serif',
        laudrygo: '"LaudrygoLocal",system-ui,sans-serif',
        nanum: '"NanumNaMuJeongWeonLocal",system-ui,sans-serif',
        bagel: '"BagelFatOneLocal",system-ui,sans-serif'
      };

      const key = item.fontKey || 'pretendard';
      t.style.fontFamily = fontMap[key] || fontMap.pretendard;
      t.style.fontSize = (item.fontSize || 24) + 'px'; // ìµœì†Œ 24px ë³´ì¥
      el.appendChild(t);
       // âœ… ì¶”ê°€: í…ìŠ¤íŠ¸ í¬ê¸°ì— ë§ì¶° ë°•ìŠ¤ ìë™ ë§ì¶¤
  fitTextBoxToContent(el, item);
    }
    
    
    // ì œìŠ¤ì²˜ ì´ë²¤íŠ¸
    el.addEventListener('pointerdown', onGesturePointerDown);
    el.addEventListener('pointermove', onGesturePointerMove);
    el.addEventListener('pointerup', onGesturePointerUp);
    el.addEventListener('pointercancel', onGesturePointerUp);

    el.addEventListener('contextmenu', e => e.preventDefault());
    el.addEventListener('dragstart', e => e.preventDefault());

    el.style.touchAction = 'none';
    el.style.userSelect = 'none';
    el.style.webkitUserSelect = 'none';

    timeline.appendChild(el);
    return el;
  }

  /* =========================
   Title Page (Step2 - Title)
   ========================= */

function ensureTitleItem(){
  const titleText = (videoTitleInput.value || '').trim();
  if (!titleText) return;

  if (!titleItem) {
    titleItem = {
      id: 'title-item',
      blockId: null,
      type: 'text',
      text: titleText,
      x: 24,
      y: 90,
      w: 312,
      h: 120,
      rotation: 0,
      fontKey: currentTitleFont,
      fontSize: 32
    };
    items.push(titleItem);
  } else {
    titleItem.text = titleText;
    titleItem.fontKey = currentTitleFont;
  }

  if (!titleItemEl) {
    titleItemEl = document.createElement('div');
    titleItemEl.className = 'timeline-item';
    titleItemEl.dataset.id = titleItem.id;

    const t = document.createElement('div');
    t.className = 'timeline-item-text';
    titleItemEl.appendChild(t);

    titleItemEl.addEventListener('pointerdown', onGesturePointerDown);
    titleItemEl.addEventListener('pointermove', onGesturePointerMove);
    titleItemEl.addEventListener('pointerup', onGesturePointerUp);
    titleItemEl.addEventListener('pointercancel', onGesturePointerUp);

    titleItemEl.addEventListener('contextmenu', e => e.preventDefault());
    titleItemEl.addEventListener('dragstart', e => e.preventDefault());

    // âœ… Step2 ì œëª© íƒ­ ì „ìš© ë ˆì´ì–´ì— ë¶™ì„
    titlePageLayer.appendChild(titleItemEl);
  }

  syncTitleItemText();
  applyTitleItemStyles();
}

function applyTitleItemStyles(){
  if (!titleItem || !titleItemEl) return;

  titleItemEl.style.left = titleItem.x + 'px';
  titleItemEl.style.top = titleItem.y + 'px';
  titleItemEl.style.width = titleItem.w + 'px';
  titleItemEl.style.height = titleItem.h + 'px';
  titleItemEl.style.transform = `rotate(${titleItem.rotation || 0}rad)`;
  titleItemEl.dataset.rotation = titleItem.rotation || 0;
  titleItemEl.style.zIndex = '9998';

  const t = titleItemEl.querySelector('.timeline-item-text');
  if (t) {
    const fontMap = {
      pretendard: '"PretendardSemiBoldLocal","Pretendard",system-ui,sans-serif',
      laudrygo: '"LaudrygoLocal",system-ui,sans-serif',
      nanum: '"NanumNaMuJeongWeonLocal",system-ui,sans-serif',
      bagel: '"BagelFatOneLocal",system-ui,sans-serif'
    };
    t.style.fontFamily = fontMap[titleItem.fontKey] || fontMap.pretendard;
    t.style.fontSize = (titleItem.fontSize || 32) + 'px';
  }

  // âœ… ì œëª©ë„ í…ìŠ¤íŠ¸ì— ë§ì¶° ë°•ìŠ¤ ìë™ ë§ì¶¤
  fitTextBoxToContent(titleItemEl, titleItem, (viewport.clientWidth || 360) - 48);
}

function syncTitleItemText(){
  if (!titleItem || !titleItemEl) return;
  const t = titleItemEl.querySelector('.timeline-item-text');
  if (t) t.textContent = titleItem.text || '';
}

function showTitleItem(show){
  if (!titleItemEl) return;
  titleItemEl.style.display = show ? 'block' : 'none';
}

function centerTitleItemInViewport(){
  if (!titleItem || !titleItemEl) return;

  requestAnimationFrame(() => {
    const vw = viewport.clientWidth || 360;
    const vh = viewport.clientHeight || 640;

    const w = parseFloat(titleItemEl.style.width) || titleItemEl.offsetWidth || 200;
    const h = parseFloat(titleItemEl.style.height) || titleItemEl.offsetHeight || 80;

    titleItem.x = Math.round((vw - w) / 2);
    titleItem.y = Math.round((vh - h) / 2);

    applyTitleItemStyles();
  });
}
/* ---------- Title BG (ë©”ì¸ + ì¶”ê°€ í©ë¿Œë¦¬ê¸°) ---------- */

function clearExtraTitleBgItems(){
  // DOM ì œê±°
  Array.from(titlePageLayer.querySelectorAll('.timeline-item')).forEach(el => {
    const id = el.dataset.id || '';
    if (id.startsWith('title-bg-extra-')) el.remove();
  });
  // ìƒíƒœ ì œê±°
  items = items.filter(it => !String(it.id).startsWith('title-bg-extra-'));
}

function ensureTitleBgItem(){
  if (!titleBgDataUrl) return;

  const vw = viewport.clientWidth || 360;
  const vh = viewport.clientHeight || 640;

  if (!titleBgItem) {
    titleBgItem = {
      id: 'title-bg-item',
      blockId: null,
      type: 'image',
      src: titleBgDataUrl,
      x: 0,
      y: 0,
      w: vw,
      h: vh,
      rotation: 0
    };
    items.push(titleBgItem);
  } else {
    // âœ… í™”ë©´ í¬ê¸° ë°”ë€Œì–´ë„ ë°°ê²½ì€ í•­ìƒ í™”ë©´ì— ë§ê²Œ
    titleBgItem.src = titleBgDataUrl;
    titleBgItem.x = 0;
    titleBgItem.y = 0;
    titleBgItem.w = vw;
    titleBgItem.h = vh;
    titleBgItem.rotation = 0;
  }

  if (!titleBgItemEl) {
    titleBgItemEl = document.createElement('div');
    titleBgItemEl.className = 'timeline-item';
    titleBgItemEl.dataset.id = titleBgItem.id;

    const img = document.createElement('img');
    img.src = titleBgItem.src;
    img.style.objectFit = 'cover'; // âœ… 9:16 ê½‰ ì±„ìš°ê¸°
    titleBgItemEl.appendChild(img);

    titleBgItemEl.addEventListener('pointerdown', onGesturePointerDown);
    titleBgItemEl.addEventListener('pointermove', onGesturePointerMove);
    titleBgItemEl.addEventListener('pointerup', onGesturePointerUp);
    titleBgItemEl.addEventListener('pointercancel', onGesturePointerUp);

    titleBgItemEl.addEventListener('contextmenu', e => e.preventDefault());
    titleBgItemEl.addEventListener('dragstart', e => e.preventDefault());

    titlePageLayer.appendChild(titleBgItemEl);
  }

  applyTitleBgItemStyles();
  /* âœ… ì¶”ê°€: bg DOM ìƒì„±/ê°±ì‹  ì´í›„ ë¸”ëŸ¬/ë”¤ì„ ë‹¤ì‹œ ê°•ì œ ë°˜ì˜ */
 applyTitleBgToTitlePage();
}

function applyTitleBgItemStyles(){
  if (!titleBgItem || !titleBgItemEl) return;

  titleBgItemEl.style.left = titleBgItem.x + 'px';
  titleBgItemEl.style.top = titleBgItem.y + 'px';
  titleBgItemEl.style.width = titleBgItem.w + 'px';
  titleBgItemEl.style.height = titleBgItem.h + 'px';
  titleBgItemEl.style.transform = `rotate(${titleBgItem.rotation || 0}rad)`;
  titleBgItemEl.dataset.rotation = titleBgItem.rotation || 0;

  // âœ… ë°°ê²½ì€ í•­ìƒ ì œì¼ ì•„ë˜
  titleBgItemEl.style.zIndex = '1';

  const img = titleBgItemEl.querySelector('img');
  if (img) img.src = titleBgItem.src;
}

function showTitleBgItem(show){
  if (!titleBgItemEl) return;
  titleBgItemEl.style.display = show ? 'block' : 'none';
}

function scatterExtraTitleBgItems(extraUrls){
  if (!Array.isArray(extraUrls) || extraUrls.length === 0) return;

  const vw = viewport.clientWidth || 360;
  const vh = viewport.clientHeight || 640;

  extraUrls.forEach((src, idx) => {
    const id = `title-bg-extra-${Date.now()}-${idx}`;

    const w = Math.round(clamp(80 + Math.random()*160, 80, vw*0.8));
    const h = Math.round(clamp(80 + Math.random()*200, 80, vh*0.7));
    const x = Math.round(clamp(Math.random()*(vw - w), 0, vw - w));
    const y = Math.round(clamp(Math.random()*(vh - h), 0, vh - h));
    const r = (Math.random()*0.6 - 0.3);

    const it = { id, blockId:null, type:'image', src, x, y, w, h, rotation:r };
    items.push(it);

    const el = document.createElement('div');
    el.className = 'timeline-item';
    el.dataset.id = it.id;
    el.style.left = it.x + 'px';
    el.style.top = it.y + 'px';
    el.style.width = it.w + 'px';
    el.style.height = it.h + 'px';
    el.style.transform = `rotate(${it.rotation}rad)`;
    el.dataset.rotation = it.rotation;
    el.style.zIndex = String(10 + idx);

    const img = document.createElement('img');
    img.src = it.src;
    img.style.objectFit = 'contain';
    el.appendChild(img);

    el.addEventListener('pointerdown', onGesturePointerDown);
    el.addEventListener('pointermove', onGesturePointerMove);
    el.addEventListener('pointerup', onGesturePointerUp);
    el.addEventListener('pointercancel', onGesturePointerUp);

    el.addEventListener('contextmenu', e => e.preventDefault());
    el.addEventListener('dragstart', e => e.preventDefault());

    titlePageLayer.appendChild(el);
  });
}
  
  /* ---------- Edit Mode ---------- */
  function enterEditMode(el) {
    exitEditMode();
    editingItemEl = el;
    el.classList.add('edit-mode','editing');
    viewport.classList.add('edit-mode');
    el.style.zIndex = (++zCounter).toString();
  }

  function exitEditMode() {
    if (editingItemEl) {
      editingItemEl.classList.remove('edit-mode','editing');
      editingItemEl = null;
    }
    viewport.classList.remove('edit-mode');
  }

  /* ---------- Animation ---------- */
  function stopAnimation(){
    if (animFrameId!==null){
      cancelAnimationFrame(animFrameId);
      animFrameId=null;
    }
  }

  function runAnimation(){
    if (!blocks.length){
      alert('ë¨¼ì € ì‹œê°„ ë¸”ë¡ì— ì•„ì´í…œì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.');
      return;
    }

    stopAnimation();
    exitEditMode();

    const mode = currentAnimationMode;
    const blocksSorted = blocks.slice().sort((a,b)=>a.startMinutes - b.startMinutes);
const viewportHeight = viewport.clientHeight;

// âœ… (ë³€ê²½) ì‹¤ì œ ì•„ì´í…œ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘/ë ê³„ì‚°
const itemEls = Array.from(timeline.querySelectorAll('.timeline-item'));

// ì•„ì´í…œì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´(ì˜ˆì™¸) ê¸°ì¡´ blocks ê¸°ì¤€ìœ¼ë¡œ fallback
let contentMinTop = 0;
let contentMaxBottom = 0;

if (itemEls.length > 0) {
  const itemTops = itemEls.map(el => parseFloat(el.style.top) || 0);
  const itemBottoms = itemEls.map(el => {
    const top = parseFloat(el.style.top) || 0;
    const h = el.offsetHeight || (parseFloat(el.style.height) || 0);
    return top + h;
  });

  contentMinTop = Math.min(...itemTops);
  contentMaxBottom = Math.max(...itemBottoms);
} else {
  // fallback: ì‹œê°„ ë¸”ë¡ ê¸°ì¤€(ê¸°ì¡´ ë¡œì§)
  const tops = blocks.map(b => parseFloat(b.element.style.top) || 0);
  const bottoms = blocks.map(b => {
    const top = parseFloat(b.element.style.top) || 0;
    return top + b.element.offsetHeight;
  });
  contentMinTop = Math.min(...tops);
  contentMaxBottom = Math.max(...bottoms);
}

// ë ìŠ¤í¬ë¡¤ ìœ„ì¹˜
let endScroll = Math.max(contentMaxBottom - viewportHeight + 40, 0);

    const durationSec = parseFloat(speedInput.value) || 8;
    const durationMs = durationSec * 1000;

    const title = videoTitleInput.value.trim();
    const hasTitle = !!title;

    function clampEndToStart(start){
      if (endScroll < start) endScroll = start;
    }

    function startScrollAnimationFrom(startScroll){
      if (mode === 'scrollReveal'){
        itemEls.forEach(el=>{
          el.classList.remove('reveal-visible');
          el.classList.add('reveal-hidden');
        });
      } else {
        itemEls.forEach(el=>{
          el.classList.remove('reveal-hidden','reveal-visible');
        });
      }

      const startTime = performance.now();

      function frame(now){
        const t = Math.min(1, (now - startTime) / durationMs);
        const current = startScroll + (endScroll - startScroll) * t;

        viewport.scrollTop = current;
        highlightHourByScroll(current);

        if (mode === 'scrollReveal'){
          const triggerLine = current + viewportHeight * 0.4;

          blocksSorted.forEach(block=>{
            const blockTop = parseFloat(block.element.style.top) || 0;
            const threshold = blockTop + block.element.offsetHeight * 0.2;

            if (triggerLine >= threshold){
              items.filter(it => it.blockId === block.id).forEach(it=>{
                const el = timeline.querySelector(`.timeline-item[data-id="${it.id}"]`);
                if (el && el.classList.contains('reveal-hidden')){
                  el.classList.remove('reveal-hidden');
                  el.classList.add('reveal-visible');
                }
              });
            }
          });
        }

        if (t < 1){
          animFrameId = requestAnimationFrame(frame);
        } else {
          animFrameId = null;
          clearHourHighlight();
        }
      }

      animFrameId = requestAnimationFrame(frame);
    }

    if (hasTitle){
      titleOverlay.textContent = title;
      titleOverlay.style.display = 'flex';

      const initialScroll = Math.max(contentMinTop - viewportHeight * 0.9, 0);
      clampEndToStart(initialScroll);

      viewport.scrollTop = initialScroll;
      highlightHourByScroll(initialScroll);

      setTimeout(()=>{
        titleOverlay.style.display = 'none';
        startScrollAnimationFrom(initialScroll);
      }, 5000);

    } else {
      const startScroll = Math.max(contentMinTop - 40, 0);
      clampEndToStart(startScroll);

      viewport.scrollTop = startScroll;
      highlightHourByScroll(startScroll);
      startScrollAnimationFrom(startScroll);
    }
  }

    /* ---------- True Fullscreen (REAL) ---------- */
  function requestViewportFullscreen() {
    const el = viewport;

    const req =
      el.requestFullscreen ||
      el.webkitRequestFullscreen ||
      el.mozRequestFullScreen ||
      el.msRequestFullscreen;

    if (!req) return Promise.reject(new Error('Fullscreen API not supported'));
    const ret = req.call(el);
    // ì–´ë–¤ ë¸Œë¼ìš°ì €ëŠ” Promiseë¥¼ ì•ˆ ì¤„ ìˆ˜ ìˆì–´ì„œ í†µì¼
    return (ret && typeof ret.then === 'function') ? ret : Promise.resolve();
  }

  function isViewportFullscreen() {
    const fsEl =
      document.fullscreenElement ||
      document.webkitFullscreenElement ||
      document.mozFullScreenElement ||
      document.msFullscreenElement;
    return fsEl === viewport;
  }

  function onFullscreenChange() {
    // í’€ìŠ¤í¬ë¦°ì—ì„œ ë¹ ì ¸ë‚˜ì˜¨ ìˆœê°„(ESC ë“±)
    if (!isViewportFullscreen()) {
      stopAnimation();
      clearHourHighlight();
      // ì œëª© ì˜¤ë²„ë ˆì´ê°€ ë– ìˆìœ¼ë©´ ì•ˆì „í•˜ê²Œ ë‚´ë¦¼
      titleOverlay.style.display = 'none';
    }
  }

  document.addEventListener('fullscreenchange', onFullscreenChange);
  document.addEventListener('webkitfullscreenchange', onFullscreenChange);
  document.addEventListener('mozfullscreenchange', onFullscreenChange);
  document.addEventListener('MSFullscreenChange', onFullscreenChange);

  /* ---------- Record Mode (Fake Fullscreen) ---------- */
  const recordExitBtn = document.getElementById('recordExitBtn');
 let recordModeReason = null; // 'titlePreview' | 'playback' | null

  function enterRecordMode(reason = 'playback') {
  recordModeReason = reason;
  document.body.classList.add('record-mode');
  const mask = viewport.querySelector('.fullscreen-mask');
  if (mask) mask.style.display = 'block';

  // âœ… ë ˆì´ì•„ì›ƒ ë³€ê²½ ì§í›„(9:16 ì¤‘ì•™ì •ë ¬) ì‚¬ì´ì¦ˆ ê¸°ë°˜ ìš”ì†Œ ì¬ì •ë ¬
  requestAnimationFrame(() => {
    if (document.body.dataset.step === '2' && document.body.dataset.step2view === 'title') {
      // ë°°ê²½/ë”¤/ë¸”ëŸ¬ê°€ â€œì•ˆ ë¨¹ëŠ”â€ íƒ€ì´ë° ë°©ì§€ìš©
      ensureTitleBgItem();
      applyTitleBgToTitlePage();
      centerTitleItemInViewport();
      syncPreviewControlsFromState();
    }
  });
}

function exitRecordMode() {
  document.body.classList.remove('record-mode');
  stopAnimation();
  clearHourHighlight();
  const mask = viewport.querySelector('.fullscreen-mask');
  if (mask) mask.style.display = 'none';
  recordModeReason = null;
}


  /* ---------- Gestures ---------- */
  function onGesturePointerDown(e) {
  const el = e.currentTarget;
  const item = getItemByElement(el);

  // âœ… í‰ìƒì‹œì—” ìŠ¤í¬ë¡¤ì„ ì‚´ë ¤ë‘”ë‹¤ (ëª¨ë°”ì¼ í•µì‹¬)
  const alreadyEditing = (editingItemEl === el);
  if (alreadyEditing) {
    e.preventDefault();
    try { el.setPointerCapture(e.pointerId); } catch(_) {}
  }

  activeTouches.push({ id:e.pointerId, x:e.clientX, y:e.clientY });

  // 1 finger: long press to enter edit mode
  if (activeTouches.length === 1) {
    longPressStartPos = { x:e.clientX, y:e.clientY };
    const pid = e.pointerId;

    longPressTimer = setTimeout(() => {
      enterEditMode(el);
      try { el.setPointerCapture(pid); } catch(_) {}

      gestureState = {
        mode:'move',
        startX:e.clientX,
        startY:e.clientY,
        origX:item.x,
        origY:item.y
      };
    }, 500);
  }

if (activeTouches.length === 2 && editingItemEl === el) {
  if (longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }

  const [t1, t2] = activeTouches;
  const dx = t2.x - t1.x;
  const dy = t2.y - t1.y;

  gestureState = {
    mode:'transform',
    startDist: Math.hypot(dx,dy),
    startAngle: Math.atan2(dy,dx),
    startRotation: item.rotation || 0,
    rotationSensitivity: 0.3,
    startWidth: item.w,
    startHeight: item.h,

    // âœ… ì¶”ê°€: í…ìŠ¤íŠ¸ë©´ í°íŠ¸ ì‚¬ì´ì¦ˆë„ ìŠ¤ì¼€ì¼ë§í•˜ê¸° ìœ„í•´ ì €ì¥
    itemType: item.type,
    startFontSize: (item.type === 'text' ? (item.fontSize || 24) : null)
  };
}

  }

  function onGesturePointerMove(e) {
    const el = e.currentTarget;
    const item = getItemByElement(el);

    if (longPressTimer && longPressStartPos) {
      const dx = Math.abs(e.clientX - longPressStartPos.x);
      const dy = Math.abs(e.clientY - longPressStartPos.y);
      if (dx > 10 || dy > 10) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
        longPressStartPos = null;
      }
    }

    activeTouches = activeTouches.map(t =>
      t.id === e.pointerId ? { ...t, x:e.clientX, y:e.clientY } : t
    );

    if (!gestureState) return;

    // move
    if (gestureState.mode === 'move' && activeTouches.length === 1 && editingItemEl === el) {
      e.preventDefault();

      const dx = e.clientX - gestureState.startX;
      const dy = e.clientY - gestureState.startY;

      const newX = gestureState.origX + dx;
      const newY = gestureState.origY + dy;

      el.style.left = `${newX}px`;
      el.style.top = `${newY}px`;
      void el.offsetHeight;

      item.x = newX;
      item.y = newY;
    }

    // transform
    if (gestureState.mode === 'transform' && activeTouches.length === 2 && editingItemEl === el) {
  e.preventDefault();

  const [t1, t2] = activeTouches;
  const dx = t2.x - t1.x;
  const dy = t2.y - t1.y;

  const dist = Math.hypot(dx,dy);
  const scale = dist / gestureState.startDist;

  const angle = Math.atan2(dy,dx);
  const angleDiff = angle - gestureState.startAngle;
  const rotation = gestureState.startRotation + (angleDiff * gestureState.rotationSensitivity);

  const newW = gestureState.startWidth * scale;
  const newH = gestureState.startHeight * scale;

  el.style.width = `${newW}px`;
  el.style.height = `${newH}px`;
  el.style.transform = `rotate(${rotation}rad)`;
  void el.offsetHeight;

  item.w = newW;
  item.h = newH;
  item.rotation = rotation;

  // âœ… ì¶”ê°€: í…ìŠ¤íŠ¸ëŠ” í°íŠ¸ í¬ê¸°ë„ ê°™ì´ ìŠ¤ì¼€ì¼
  if (gestureState.itemType === 'text') {
    const minFont = 24;
    const maxFont = 160; // í•„ìš”í•˜ë©´ ì¡°ì ˆ
    const newFont = clamp(Math.round(gestureState.startFontSize * scale), minFont, maxFont);

    item.fontSize = newFont;
    const t = el.querySelector('.timeline-item-text');
    if (t) t.style.fontSize = newFont + 'px';
  }
}

  }

  function onGesturePointerUp(e) {
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      longPressTimer = null;
    }
    longPressStartPos = null;

    activeTouches = activeTouches.filter(t => t.id !== e.pointerId);

    if (activeTouches.length === 0) {
      gestureState = null;
        // âœ… [ì¶”ê°€] title-itemì„ ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ê±´ë“œë ¸ìœ¼ë©´ ì´í›„ì—” ì¤‘ì•™ì •ë ¬ ì•ˆ í•¨
    if (editingItemEl && editingItemEl.dataset.id === 'title-item') {
      titleItemUserMoved = true;
    }
      // âœ… ë“œë˜ê·¸/í•€ì¹˜/íšŒì „ ì¡°ì‘ì´ ëë‚˜ëŠ” ìˆœê°„ ì¦‰ì‹œ ì €ì¥ + 3ë¶„ ë°±ì—… ì˜ˆì•½
      markDirtyAndSave('gestureEnd');
    }
  }

  /* ---------- Events ---------- */
 // ì´ˆê¸° ì ìš©(ì €ì¥ ì—†ì´ UIë§Œ ë°˜ì˜)
applyTitleFontUI(currentTitleFont);
applyTextFontUI(currentTextFont);

buildTimeOptions();

// âœ… 1) ì €ì¥ëœ ê²Œ ìˆìœ¼ë©´ ë³µì›, ì—†ìœ¼ë©´ ì‹ ê·œ ì´ˆê¸°í™”
const restored = loadStateAndRestore();

if (!restored) {
  resetTimelineDataAndDom();

  const today = new Date().toISOString().slice(0,10);
  dateInput.value = today;
  headerLabel.textContent = today + ' íƒ€ì„ë¼ì¸';
  updateHeaderDateByScroll(viewport.scrollTop);

  // ê¸°ë³¸ ìƒíƒœ ë°˜ì˜
  applyItemTypeUI(currentItemType);
  applyAnimationModeUI(currentAnimationMode);

  updateStep2SubNavVisibility();
}
  
 dateInput.addEventListener('change', () => {
  resetTimelineDataAndDom();
  updateHeaderDateByScroll(viewport.scrollTop);
  markDirtyAndSave('dateChange');
});


 videoTitleInput.addEventListener('input', () => {
  // âœ… ì œëª©ì´ ìˆìœ¼ë©´ titleItem ì¤€ë¹„ + í…ìŠ¤íŠ¸ ì‹±í¬
  if (hasVideoTitle()) {
    ensureTitleItem();
    syncTitleItemText();
    applyTitleItemStyles();
  }

  // âœ… step2ì—ì„œë§Œ ì¡°ê±´ë¶€ë¡œ ì„œë¸Œíƒ­ ë³´ì´ê²Œ
  updateStep2SubNavVisibility();

  markDirtyAndSave('titleInput');
});

  
  datePickerBtn.addEventListener('click', () => {
    if (typeof dateInput.showPicker === 'function') dateInput.showPicker();
    else { dateInput.focus(); dateInput.click(); }
  });

  startTimeSelect.addEventListener('change', () => {
    updateEndTimeOptions(parseInt(startTimeSelect.value,10));
  });

  itemTypeButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      itemTypeButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentItemType = btn.dataset.type;

      if (currentItemType==='text') {
        textInputGroup.style.display='block';
        imageInputGroup.style.display='none';
      } else {
        textInputGroup.style.display='none';
        imageInputGroup.style.display='block';
      }
       markDirtyAndSave('itemTypeChange'); 
    });
  });

  animationModeButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      animationModeButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentAnimationMode = btn.dataset.mode;
       markDirtyAndSave('animationModeChange');
    });
  });

  // ê¸°ë³¸ í‘œì‹œ ìƒíƒœ
  textInputGroup.style.display='none';
  imageInputGroup.style.display='block';

  speedInput.addEventListener('input',()=>{ 
    speedLabel.textContent = speedInput.value + 'ì´ˆ';
    markDirtyAndSave('speedChange');   });
  speedLabel.textContent = speedInput.value + 'ì´ˆ';

  addItemBtn.addEventListener('click',()=>{
    if (!dateInput.value){
      alert('ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const startMinutes = parseInt(startTimeSelect.value,10);
    const endMinutes = parseInt(endTimeSelect.value,10);

    if (isNaN(startMinutes)||isNaN(endMinutes)||endMinutes<=startMinutes){
      alert('ì‹œì‘/ë ì‹œê°„ì„ ì˜¬ë°”ë¥´ê²Œ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const itemData = {
      id:'item-'+Date.now()+'-'+Math.random().toString(16).slice(2),
      blockId:null,
      type:'',
      x:0,y:0,w:0,h:0,
      rotation:0
    };

    let itemType;

    if (currentItemType==='text'){
      const text = textContentInput.value.trim();
      if (!text){ alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      itemType='text';
      itemData.text=text;
      itemData.fontKey = currentTextFont;
    } else {
      const file = imageFileInput.files[0];
      if (!file){ alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
      itemData.src = URL.createObjectURL(file);
      itemType = file.type && file.type.startsWith('video/') ? 'video' : 'image';
    }

    itemData.type=itemType;

    const block = getOrCreateBlock(startMinutes,endMinutes);
    itemData.blockId=block.id;

    const blockRect = block.element.getBoundingClientRect();
    const blockTop = parseFloat(block.element.style.top) || 0;
    const blockHeight = parseFloat(block.element.style.height) || 0;

    const existing = items.filter(it=>it.blockId===block.id);

    if (!existing.length){
      const padding=12;
      const availableWidth = blockRect.width - 32;
      const availableHeight = Math.max(MIN_ITEM_HEIGHT, blockHeight - padding*2);

      itemData.x=70;
      itemData.y=blockTop + padding;
      itemData.w=availableWidth;
      itemData.h=availableHeight;
    } else {
      const w = Math.max(80, blockRect.width*0.5);
      const h = Math.max(MIN_ITEM_HEIGHT, Math.max(80, blockRect.height*0.5));

      itemData.w=w; itemData.h=h;
      itemData.x=70 + (blockRect.width-w)/2;
      itemData.y=blockTop + (blockRect.height-h)/2;
    }

    items.push(itemData);
    createItemElement(itemData);

    scrollToBlock(block.id);

    if (itemType==='image'||itemType==='video') imageFileInput.value='';
    updateBlockList();
    markDirtyAndSave('addItem');
  });

  playBtn.addEventListener('click', runAnimation);

   playFullscreenBtn.addEventListener('click', async () => {
    // ë¨¼ì € í¸ì§‘/ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ì •ë¦¬
    stopAnimation();
    exitEditMode();

    try {
      // âœ… ì§„ì§œ ì „ì²´í™”ë©´ ìš”ì²­
      await requestViewportFullscreen();
    } catch (err) {
      // âœ… Fullscreen API ë¯¸ì§€ì›/ì°¨ë‹¨ì´ë©´ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ fallback
      enterRecordMode('playback');
    }

    // âœ… ë ˆì´ì•„ì›ƒ ë³€ê²½(ì „ì²´í™”ë©´) ë°˜ì˜ í›„ ì¬ìƒ ì‹œì‘
    requestAnimationFrame(() => requestAnimationFrame(() => runAnimation()));
  });


  recordExitBtn.addEventListener('click', () => {
  if (recordModeReason === 'titlePreview') {
    // âœ… Step2 "íƒ€ì„ë¼ì¸ í¸ì§‘" íƒ­ìœ¼ë¡œ ìë™ ì´ë™
    exitRecordMode();
    setStep2View('timeline');
  } else {
    // (ê¸°ì¡´) ì¬ìƒ fallback record-mode ì¢…ë£Œ
    exitRecordMode();
  }
});

  document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (recordModeReason === 'titlePreview') {
      exitRecordMode();
      setStep2View('timeline');
    } else {
      exitRecordMode();
    }
  }
});

  viewport.addEventListener('scroll',()=>{
    if (animFrameId===null) highlightHourByScroll(viewport.scrollTop);
  });

 stepButtons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const step = btn.dataset.step;

    stepButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');

    Object.entries(stepPanels).forEach(([key,p])=>{
      if (key===step) p.classList.add('active');
      else p.classList.remove('active');
    });

    document.body.dataset.step = step;

    // âœ… step2 ì§„ì…/ì´íƒˆ ì‹œ ì„œë¸Œíƒ­ í‘œì‹œ ì¡°ê±´ ê°±ì‹ 
    updateStep2SubNavVisibility();

    // âœ… [ì¶”ê°€] Step2 ë“¤ì–´ì˜¤ë©´ ë¬´ì¡°ê±´ "íƒ€ì„ë¼ì¸ í¸ì§‘"ë¶€í„°
    if (step === '2') {
      // titlePreview record-mode ì”ìƒ ì œê±°
      if (document.body.classList.contains('record-mode')) exitRecordMode();

      // ì„œë¸Œíƒ­ì´ ë³´ì—¬ë„ ê¸°ë³¸ì€ timeline
      setStep2View('timeline');
    } else {
      // step2 ë°–ì—ì„œëŠ” title ë ˆì´ì–´/record-modeê°€ ë‚¨ì§€ ì•Šê²Œ
      if (document.body.classList.contains('record-mode')) exitRecordMode();
      document.body.dataset.step2view = 'timeline';
      if (titlePageLayer) titlePageLayer.style.display = 'none';
      showTitleItem(false);
      showTitleBgItem(false);
    }

    markDirtyAndSave('stepChange');
  });
});


  // âœ… Step2 ì„œë¸Œíƒ­ í´ë¦­
step2SubNav.querySelectorAll('.sub-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    setStep2View(btn.dataset.view);
    markDirtyAndSave('step2SubViewChange');
  });
});

themeToggleBtn.addEventListener('click', () => {
  const body = document.body;
  if (body.classList.contains('theme-dark')) {
    body.classList.remove('theme-dark');
    body.classList.add('theme-light');
    themeToggleBtn.textContent = 'ë‹¤í¬ ëª¨ë“œ';
  } else {
    body.classList.remove('theme-light');
    body.classList.add('theme-dark');
    themeToggleBtn.textContent = 'ë¼ì´íŠ¸ ëª¨ë“œ';
  }
  markDirtyAndSave('themeChange'); // âœ… ì¶”ê°€
});

  /* ---------- Title BG State ---------- */
  function applyTitleBgToOverlay(){
    if (!titleBgDataUrl) {
      titleOverlay.classList.remove('has-bg');
      titleOverlay.style.removeProperty('--title-bg-url');
      return;
    }
    titleOverlay.classList.add('has-bg');
    titleOverlay.style.setProperty('--title-bg-url', `url("${titleBgDataUrl}")`);

    const blurPx = Number(titleBgBlurPx || 0); // 0ì´ë©´ OFF
titleOverlay.style.setProperty('--title-bg-blur', blurPx + 'px');
    titleOverlay.style.setProperty('--title-bg-dim', (titleBgDimPct / 100).toFixed(2));
    applyTitleBgToTitlePage(); // âœ… titlePageLayerì—ë„ ê°™ì´ ë°˜ì˜
  }

  // âœ… Title í¸ì§‘ í™”ë©´(titlePageLayer)ì—ë„ ë¸”ëŸ¬/ë”¤ ì ìš©
let titleBgDimLayerEl = null;

function ensureTitleBgDimLayer(){
  if (titleBgDimLayerEl) return;
  titleBgDimLayerEl = document.createElement('div');
  titleBgDimLayerEl.id = 'titleBgDimLayer';
  titlePageLayer.appendChild(titleBgDimLayerEl);
}

// âœ… ì´ í•¨ìˆ˜ë¥¼ ì—¬ê¸°ì— ì¶”ê°€
function applyTitleBgToTitlePage(){
  // ë°°ê²½ ì—†ìœ¼ë©´ ì •ë¦¬
  if (!titleBgDataUrl){
    if (titleBgDimLayerEl) titleBgDimLayerEl.style.display = 'none';
    // blurë„ í•´ì œ
    if (titleBgItemEl){
      const img = titleBgItemEl.querySelector('img');
      if (img) { 
        img.style.filter = 'none'; 
        img.style.transform = ''; 
      }
    }
    return;
  }

  // 1) ë©”ì¸ ë°°ê²½(title-bg-item)ì— ë¸”ëŸ¬ ì ìš©
  if (titleBgItemEl){
    const img = titleBgItemEl.querySelector('img');
    if (img){
      const blurPx = Number(titleBgBlurPx || 0);
      img.style.filter = blurPx > 0 ? `blur(${blurPx}px)` : 'none';
      // blur ê°€ì¥ìë¦¬ í‹° ë°©ì§€(ê°€ë³ê²Œ í™•ëŒ€)
      img.style.transform = blurPx > 0 ? 'scale(1.05)' : '';
    }
  }

  // 2) ë”¤ì€ ë ˆì´ì–´ë¡œ ë®ê¸° (ì¶”ê°€ë¡œ ë¿Œë¦° ì´ë¯¸ì§€ë“¤ë„ ê°™ì´ ì–´ë‘ì›Œì§)
  ensureTitleBgDimLayer();
  const alpha = clamp(Number(titleBgDimPct || 0), 0, 80) / 100;
  titleBgDimLayerEl.style.display = 'block';
  titleBgDimLayerEl.style.background = `rgba(0,0,0,${alpha.toFixed(2)})`;
}

function refreshTitleBgMetaUI(){
  if (!titleBgDataUrl) {
    titleBgMeta.style.display = 'none';
    titleBgName.textContent = '';
    return;
  }
  titleBgMeta.style.display = 'flex';
}



  function refreshTitleBgMetaUI(){
    if (!titleBgDataUrl) {
      titleBgMeta.style.display = 'none';
      titleBgName.textContent = '';
      return;
    }
    titleBgMeta.style.display = 'flex';
  }

function readAsDataURL(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ''));
    r.onerror = () => reject(r.error || new Error('read failed'));
    r.readAsDataURL(file);
  });
}

async function setTitleBgFiles(fileList){
  const files = Array.from(fileList || []);
  if (!files.length) return;

  const urls = await Promise.all(files.map(f => readAsDataURL(f)));

  titleBgList = urls;
  titleBgDataUrl = urls[0] || null;

  // íŒŒì¼ëª… í‘œì‹œ(ì²«ë²ˆì§¸ ê¸°ì¤€)
  titleBgName.textContent =
    (files[0].name || 'ì„ íƒëœ ì´ë¯¸ì§€') + (files.length > 1 ? ` (+${files.length-1})` : '');

  refreshTitleBgMetaUI();
  applyTitleBgToOverlay();     // âœ… ì• ë‹ˆë©”ì´ì…˜ titleOverlayì—ë„ ê·¸ëŒ€ë¡œ ì ìš©ë¨

  // âœ… íƒ€ì´í‹€ í˜ì´ì§€ ì•„ì´í…œìœ¼ë¡œ ë°˜ì˜
  ensureTitleBgItem();         // ì²«ë²ˆì§¸ëŠ” 9:16 ê½‰ ì±„ìš°ëŠ” ë©”ì¸ ë°°ê²½
  clearExtraTitleBgItems();
  scatterExtraTitleBgItems(urls.slice(1)); // ë‚˜ë¨¸ì§€ëŠ” ëœë¤ í©ë¿Œë¦¬ê¸°

  updateStep2TitleControlsVisibility();
  markDirtyAndSave('titleBgSetMulti');
}


function clearTitleBg(){
  // ìƒíƒœ ì´ˆê¸°í™”
  titleBgList = [];
  titleBgDataUrl = null;
  titleBgBlurPx = 0;
  titleBgDimPct = 45;

  // íƒ€ì´í‹€ í˜ì´ì§€ ë ˆì´ì–´ì—ì„œ ë°°ê²½ ê´€ë ¨ ì•„ì´í…œ ì œê±°
  // (ë©”ì¸ ë°°ê²½)
  if (titleBgItemEl && titleBgItemEl.parentElement) titleBgItemEl.parentElement.removeChild(titleBgItemEl);
  titleBgItemEl = null;
  titleBgItem = null;

  // (ì¶”ê°€ ë°°ê²½ë“¤)
  Array.from(titlePageLayer.querySelectorAll('.timeline-item')).forEach(el => {
    const id = el.dataset.id || '';
    if (id.startsWith('title-bg-extra-')) {
      el.remove();
    }
  });
  items = items.filter(it => it.id !== 'title-bg-item' && !String(it.id).startsWith('title-bg-extra-'));

  // UI
  titleBlurRange.value = '0';
  titleBlurLabel.textContent = '0px (OFF)';

  titleDimRange.value = '45';
  titleDimLabel.textContent = '45%';

  refreshTitleBgMetaUI();
  applyTitleBgToOverlay(); // titleOverlayìª½ë„ ì œê±°
  updateStep2TitleControlsVisibility();

  markDirtyAndSave('titleBgClear');
}


  function updateStep2TitleControlsVisibility(){
    // step2 + ì œëª©íƒ­ + ë°°ê²½ì‚¬ì§„ ìˆì„ ë•Œë§Œ í‘œì‹œ
    const isStep2 = document.body.dataset.step === '2';
    const show = isStep2 && (step2View === 'title') && !!titleBgDataUrl;
    step2TitleControls.style.display = show ? 'block' : 'none';
  }

  // âœ… íŒŒì¼ ì¶”ê°€ ë²„íŠ¼ -> íŒŒì¼ ì„ íƒ ì—´ê¸°
  titleBgPickBtn.addEventListener('click', () => titleBgFile.click());

  // âœ… íŒŒì¼ ì„ íƒ ì‹œ ì ìš©
 titleBgFile.addEventListener('change', async () => {
  const files = titleBgFile.files;
  if (!files || !files.length) return;

  await setTitleBgFiles(files);
  titleBgFile.value = '';
});


  // âœ… X ì‚­ì œ
  titleBgClearBtn.addEventListener('click', () => clearTitleBg());
  pvBlurRange.addEventListener('input', () => {
  titleBgBlurPx = Number(pvBlurRange.value || 0);

  // ê¸°ì¡´(ì‚¬ì´ë“œ) UIë„ ê°’ ë§ì¶°ë‘ê¸° (ë‚˜ì¤‘ì— ë‹¤ì‹œ ì¼œë„ ë™ê¸°í™”)
  titleBlurRange.value = String(titleBgBlurPx);
  titleBlurLabel.textContent = titleBgBlurPx === 0 ? '0px (OFF)' : (titleBgBlurPx + 'px');

  pvBlurPill.textContent = titleBgBlurPx === 0 ? '0px (OFF)' : (titleBgBlurPx + 'px');

  applyTitleBgToOverlay();
  markDirtyAndSave('pvTitleBlur');
});

pvDimRange.addEventListener('input', () => {
  titleBgDimPct = Number(pvDimRange.value || 0);

  titleDimRange.value = String(titleBgDimPct);
  titleDimLabel.textContent = titleBgDimPct + '%';

  pvDimPill.textContent = titleBgDimPct + '%';

  applyTitleBgToOverlay();
  markDirtyAndSave('pvTitleDim');
});
  
  // âœ… Step2: ë¸”ëŸ¬ í† ê¸€/ë²”ìœ„/ë”¤ ì ìš©
  titleBlurRange.addEventListener('input', () => {
  titleBgBlurPx = Number(titleBlurRange.value || 0);
  titleBlurLabel.textContent = titleBgBlurPx === 0 ? '0px (OFF)' : (titleBgBlurPx + 'px');
  applyTitleBgToOverlay();
  markDirtyAndSave('titleBlurRange');
});

  titleDimRange.addEventListener('input', () => {
    titleBgDimPct = Number(titleDimRange.value || 0);
    titleDimLabel.textContent = titleBgDimPct + '%';
    applyTitleBgToOverlay();
     syncPreviewControlsFromState();
    markDirtyAndSave('titleDimRange');
  });

  
  // íƒ€ì„ë¼ì¸ ë°°ê²½ í´ë¦­ ì‹œ í¸ì§‘ ëª¨ë“œ í•´ì œ
  timeline.addEventListener('click', (e) => {
    if (e.target === timeline || e.target.classList.contains('timeline-inner')) {
      exitEditMode();
    }
  });

})();
</script>
  </div>
  
<!-- </body> ë°”ë¡œ ìœ„(ë˜ëŠ” <head> ì•ˆ) ì•„ë¬´ë°ë‚˜ ì¶”ê°€ -->
</body>
</html>








