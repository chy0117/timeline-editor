<!-- Timeline Story Editor v2.1 -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>íƒ€ì„ë¼ì¸ ìŠ¤í† ë¦¬ ì—ë””í„°</title>
  <style>
  /* ================================
     Timeline Story Editor v2.1 (CLEAN)
     - ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ / CSS ì •ë¦¬
     ================================ */

  /* ---------- Theme Variables ---------- */
  :root{
    --bg:#020617;
    --fg:#e5e7eb;
    --sidebar-bg:#020617;
    --border:#111827;
    --viewport-bg:#020617;
    --block-bg:#020617;
    --hour-label:#6b7280;
    --hour-line:rgba(31,41,55,0.8);
    --accent:#22c55e;
    --accent-strong:#16a34a;
    --muted:#6b7280;

    /* ---------- Global UI Scale ---------- */
    --ui-label:16px;
    --ui-input:16px;
    --ui-small:14px;
    --ui-radius:16px;
    --ui-pad-y:12px;
    --ui-pad-x:14px;
    --ui-gap:16px;
    --ui-row-gap:10px;
    --ui-min-hit:44px;
  }

  body.theme-light{
    --bg:#f9fafb;
    --fg:#020617;
    --sidebar-bg:#ffffff;
    --border:#e5e7eb;
    --viewport-bg:#f3f4f6;
    --block-bg:#ffffff;
    --hour-label:#9ca3af;
    --hour-line:#e5e7eb;
    --accent:#22c55e;
    --accent-strong:#15803d;
    --muted:#9ca3af;
  }

  *{ box-sizing:border-box; }

  /* ---------- Base Layout ---------- */
  body{
    margin:0;
    height:100vh;
    display:flex;
    background:var(--bg);
    color:var(--fg);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    font-size:var(--ui-input);
  }

  .sidebar{
    width:360px;
    height:100vh;
    overflow-y:auto;
    padding:18px 20px;
    background:var(--sidebar-bg);
    border-right:1px solid var(--border);
    display:flex;
    flex-direction:column;
    gap:var(--ui-gap);
    z-index:2;
  }

  .main{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
  }

  h1{
    font-size:20px;
    margin:0 0 10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    flex-wrap:nowrap; /* ì œëª© ì„¸ë¡œ ê¹¨ì§ ë°©ì§€ */
  }

  /* ---------- Typography ---------- */
  label{
    display:block;
    font-size:var(--ui-label);
    margin-bottom:8px;
    line-height:1.2;
    color:rgba(229,231,235,0.90);
  }
  body.theme-light label{ color:rgba(2,6,23,0.70); }

  .hint{
    font-size:var(--ui-small);
    color:var(--muted);
    line-height:1.45;
    margin:6px 0 0;
  }

  /* Step1ì—ì„œëŠ” ì„¤ëª… í…ìŠ¤íŠ¸ ìˆ¨ê¹€(ì˜¨ë³´ë”©/ì„¤ëª…ì„œë¡œ ë¶„ë¦¬) */
  body[data-step="1"] .hint{ display:none !important; }

  /* ---------- Form Controls ---------- */
  input,select,textarea,button{
    font-size:var(--ui-input);
    padding:var(--ui-pad-y) var(--ui-pad-x);
    border-radius:var(--ui-radius);
    border:1px solid var(--border);
    background:var(--bg);
    color:var(--fg);
    min-height:var(--ui-min-hit);
  }
  input,select,textarea{ width:100%; }
  button{ width:auto; cursor:pointer; font-weight:600; margin-top:0; }
  textarea{ resize:vertical; min-height:96px; }
  input[type="file"]{
    min-height:auto;
    padding:8px 8px;
    border-radius:12px;
    background:transparent;
  }

  .row{
    display:flex;
    gap:var(--ui-row-gap);
    align-items:center;
  }
  .row > *{ flex:1; }

  /* ---------- Buttons ---------- */
  .btn-primary, .btn-secondary{ width:100%; } /* í° ì•¡ì…˜ ë²„íŠ¼ë§Œ í’€í­ */

  .btn-primary{
    background:var(--accent);
    border-color:var(--accent-strong);
    color:#020617;
  }
  .btn-primary:hover{ background:var(--accent-strong); }

  .btn-secondary{
    background:transparent;
    border-color:var(--border);
    color:var(--fg);
  }
  .btn-secondary:hover{ background:rgba(148,163,184,0.12); }

  .btn-theme{
    width:auto !important;
    min-height:40px;
    padding:8px 12px;
    font-size:12px;
    border-radius:999px;
    white-space:nowrap;
    flex-shrink:0;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }

  .btn-date{
    flex:0 0 auto;
    width:auto;
    min-height:var(--ui-min-hit);
    padding:var(--ui-pad-y) 12px;
    font-size:var(--ui-input);
    margin-top:0;
  }
  /* ìº˜ë¦°ë” ë²„íŠ¼ full width ë°©ì§€ */
  #datePickerBtn.btn-date{
    width:48px !important;
    min-width:48px !important;
    padding:0 !important;
  }

  /* ---------- Step Navigation ---------- */
  .step-nav{
    display:flex;
    gap:10px;
    margin:6px 0 10px;
  }
  .step-btn{
    flex:1;
    padding:10px 10px;
    font-size:14px;
    border-radius:999px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--muted);
    cursor:pointer;
    white-space:nowrap;
  }
  .step-btn.active{
    background:var(--accent);
    border-color:var(--accent-strong);
    color:#020617;
  }
  .step-panel{ display:none; }
  .step-panel.active{ display:block; }

  /* ---------- Toggle Buttons (ê³µí†µ) ---------- */
  .item-type-toggle,
  .animation-mode-toggle,
  .title-font-toggle,
  .text-font-toggle{
    display:flex;
    gap:6px;
    margin-top:8px;
  }

  .item-type-toggle .toggle-btn,
  .animation-mode-toggle .toggle-btn,
  .title-font-toggle .toggle-btn,
  .text-font-toggle .toggle-btn{
    flex:1;
    padding:0 10px;      /* ìœ„ì•„ë˜ íŒ¨ë”© ì œê±° (ë†’ì´ë¡œ ê´€ë¦¬) */
    min-height:44px;     /* ëª¨ë°”ì¼ í„°ì¹˜ íƒ€ê²Ÿ */
    font-size:18px;      /* í°íŠ¸ ì°¨ì´ ë³´ì´ê²Œ */
    line-height:1;
    border-radius:999px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--muted);
    cursor:pointer;
    margin-top:0;
    white-space:nowrap;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }

  .item-type-toggle .toggle-btn.active,
  .animation-mode-toggle .toggle-btn.active,
  .title-font-toggle .toggle-btn.active,
  .text-font-toggle .toggle-btn.active{
    background:var(--accent);
    border-color:var(--accent-strong);
    color:#020617;
  }

  /* ë²„íŠ¼ ê¸€ì”¨ê°€ í°íŠ¸ ë¯¸ë¦¬ë³´ê¸°ì²˜ëŸ¼ ë³´ì´ê²Œ */
  .title-font-toggle .toggle-btn[data-font="pretendard"],
  .text-font-toggle  .toggle-btn[data-font="pretendard"]{
    font-family:"PretendardSemiBoldLocal","Pretendard",system-ui,sans-serif;
  }
  .title-font-toggle .toggle-btn[data-font="laudrygo"],
  .text-font-toggle  .toggle-btn[data-font="laudrygo"]{
    font-family:"LaudrygoLocal",system-ui,sans-serif;
  }
  .title-font-toggle .toggle-btn[data-font="nanum"],
  .text-font-toggle  .toggle-btn[data-font="nanum"]{
    font-family:"NanumNaMuJeongWeonLocal",system-ui,sans-serif;
  }
  .title-font-toggle .toggle-btn[data-font="bagel"],
  .text-font-toggle  .toggle-btn[data-font="bagel"]{
    font-family:"BagelFatOneLocal",system-ui,sans-serif;
  }

  /* ---------- Speed Row ---------- */
  .speed-row{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .speed-row input[type="range"]{ flex:1; min-height:auto; }
  .speed-row span{
    font-size:12px;
    color:var(--muted);
    min-width:40px;
    text-align:right;
  }

  /* ---------- Block List ---------- */
  .block-list{
    list-style:none;
    padding-left:0;
    margin:4px 0 0;
    max-height:180px;
    overflow-y:auto;
    font-size:13px;
  }
  .block-list li{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    margin-bottom:6px;
    border-radius:10px;
    border:1px solid var(--border);
    cursor:pointer;
    min-width:0;
    overflow:hidden;
  }
  .block-list span.time{
    flex:1 1 auto;
    min-width:120px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    font-weight:500;
    color:var(--fg);
  }
  .block-right-group{
    display:flex;
    align-items:center;
    gap:6px;
    flex-shrink:0;
  }
  .block-list span.count{
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
  }
  .block-delete-btn{
    width:22px !important;
    min-width:22px !important;
    height:22px !important;
    padding:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:var(--muted);
    background:transparent;
    border:1px solid var(--border);
    border-radius:50%;
    cursor:pointer;
    flex-shrink:0;
  }

  /* ---------- Step1 Placeholder ---------- */
  .step1-placeholder{
    display:none;
    align-items:center;
    justify-content:center;
    font-size:13px;
    color:var(--muted);
    text-align:center;
    padding:16px;
    height:100%;
  }

  body[data-step="1"] .timeline-viewport{ display:none; }
  body[data-step="1"] .step1-placeholder{ display:flex; }
  body[data-step="1"] .main{ display:none !important; }
  body[data-step="1"] .sidebar{
    width:100% !important;
    max-width:480px;
    margin:0 auto;
    border-right:none;
  }
  body[data-step="2"] .timeline-viewport,
  body[data-step="3"] .timeline-viewport{ display:block; }
  body[data-step="2"] .step1-placeholder,
  body[data-step="3"] .step1-placeholder{ display:none; }

  /* ---------- Timeline Viewport ---------- */
  .timeline-viewport{
    width:360px;
    height:640px;
    max-width:100%;
    border-radius:24px;
    background:var(--viewport-bg);
    border:2px solid var(--border);
    overflow-y:auto;
    overflow-x:hidden;
    position:relative;
    box-shadow:0 20px 40px rgba(0,0,0,0.3);
  }

  /* í¸ì§‘ ëª¨ë“œ ë°°ê²½ ì˜¤ë²„ë ˆì´ */
  .timeline-viewport::before{
    content:'';
    position:absolute;
    inset:0;
    background:rgba(0,0,0,0.4);
    opacity:0;
    pointer-events:none;
    transition:opacity 0.3s;
    z-index:5;
  }
  body.theme-light .timeline-viewport::before{ background:rgba(0,0,0,0.2); }
  .timeline-viewport.edit-mode::before{ opacity:1; }

  .viewport-header{
    position:sticky;
    top:0;
    left:0;
    right:0;
    text-align:center;
    font-size:12px;
    color:var(--muted);
    padding:6px 0;
    background:linear-gradient(to bottom,rgba(2,6,23,0.9),rgba(2,6,23,0));
    z-index:6;
  }
  body.theme-light .viewport-header{
    background:linear-gradient(to bottom,rgba(249,250,251,0.95),rgba(249,250,251,0));
  }

  /* ---------- Title Overlay (ì¤‘ì•™) ---------- */
  .timeline-title-overlay{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    padding:24px;
    text-align:center;
    font-size:32px;
    font-weight:700;
    line-height:1.4;
    background:rgba(0,0,0,0.6);
    color:#f9fafb;
    z-index:7;
    /* í°íŠ¸ í”„ë¦¬ì…‹ */
    --title-font:"PretendardSemiBoldLocal";
    font-family:var(--title-font),system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  }
  body.theme-light .timeline-title-overlay{
    background:rgba(15,23,42,0.25);
    color:#020617;
  }
  .timeline-title-overlay.titlefont-bagel{ --title-font:"BagelFatOneLocal"; }
  .timeline-title-overlay.titlefont-nanum{ --title-font:"NanumNaMuJeongWeonLocal"; }
  .timeline-title-overlay.titlefont-pretendard{ --title-font:"PretendardSemiBoldLocal"; }
  .timeline-title-overlay.titlefont-laudrygo{ --title-font:"LaudrygoLocal"; }

  /* ---------- Timeline Inner / Grid ---------- */
  .timeline-inner{
    position:relative;
    width:100%;
    height:5760px;
    background:repeating-linear-gradient(
      to bottom,
      var(--viewport-bg),
      var(--viewport-bg) 60px,
      rgba(15,23,42,0.03) 60px,
      rgba(15,23,42,0.03) 120px
    );
  }
  body.theme-light .timeline-inner{
    background:repeating-linear-gradient(
      #f3f4f6,
      #f3f4f6 60px,
      #e5e7eb 60px,
      #e5e7eb 120px
    );
  }

  .hour-label{
    position:absolute;
    left:8px;
    font-size:10px;
    color:var(--hour-label);
    transition:color .2s,font-weight .2s;
  }
  .hour-label.active{ color:var(--accent); font-weight:600; }

  .hour-line{
    position:absolute;
    left:52px;
    right:8px;
    height:1px;
    background:var(--hour-line);
  }

  /* ---------- Time Block ---------- */
  .time-block{
    position:absolute;
    left:60px;
    right:12px;
    border-radius:18px;
    background:transparent;
    border:none;
    padding:4px;
    box-shadow:none;
    overflow:hidden;
    pointer-events:none;
  }
  .time-block-inner{
    position:relative;
    width:100%;
    height:100%;
    border-radius:14px;
    background:transparent;
  }

  /* ---------- Timeline Item ---------- */
  .timeline-item{
    position:absolute;
    border-radius:12px;
    overflow:hidden;
    cursor:pointer;
    box-shadow:0 0 0 1px rgba(148,163,184,0.4);
    transform-origin:center center;

    /* íˆ¬ëª… PNG/ì•ŒíŒŒ ë¹„ë””ì˜¤ ë’¤ê°€ ê²€ê²Œ ë³´ì´ëŠ” ì›ì¸ ì œê±° */
    background:transparent;

    opacity:1;
    transition:opacity .4s ease;
    z-index:1;
    touch-action:none;
    user-select:none;
    -webkit-user-select:none;
    -webkit-touch-callout:none;
    will-change:transform;
  }

  .timeline-item.editing{ transition:none; }
  .timeline-item.edit-mode{
    box-shadow:0 0 0 3px var(--accent), 0 8px 20px rgba(34,197,94,0.3);
    z-index:10 !important;
  }
  .timeline-item.dragging{
    transform:scale(1.05);
    box-shadow:0 0 0 3px var(--accent), 0 12px 24px rgba(0,0,0,0.4);
  }

  .timeline-item img,
  .timeline-item video{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
    pointer-events:none;
    user-select:none;
    -webkit-user-select:none;
    -webkit-touch-callout:none;
    backface-visibility:hidden;
    -webkit-backface-visibility:hidden;
    transform:translateZ(0);
    -webkit-transform:translateZ(0);
  }

  .timeline-item-text{
    width:100%;
    height:100%;
    padding:6px 8px;
    font-size:24px;
    line-height:1.35;
    color:#f9fafb;
    word-break:break-word;
    background:transparent;
  }
  body.theme-light .timeline-item-text{
    color:#111827;
    background:transparent;
  }

  .timeline-item.reveal-hidden{ opacity:0; }
  .timeline-item.reveal-visible{ opacity:1; }

  /* ---------- Fullscreen (API) ---------- */
  .timeline-viewport:fullscreen,
  .timeline-viewport:-webkit-full-screen,
  .timeline-viewport:-moz-full-screen,
  .timeline-viewport:-ms-fullscreen{
    position:fixed !important;
    top:0;
    left:0;
    width:100vw !important;
    height:100vh !important;
    max-width:100vw !important;
    max-height:100vh !important;
    border-radius:0 !important;
    border:none !important;
    overflow-y:auto !important;
    overflow-x:hidden !important;
  }
  .timeline-viewport:fullscreen .timeline-inner,
  .timeline-viewport:-webkit-full-screen .timeline-inner{
    width:100% !important;
  }
  @media screen and (orientation:landscape){
    .timeline-viewport:fullscreen,
    .timeline-viewport:-webkit-full-screen{
      width:56.25vh !important; /* 9:16 ë¹„ìœ¨ ìœ ì§€ */
      max-width:56.25vh !important;
      margin:0 auto !important;
      background:#000 !important;
    }
  }

  /* ---------- Fullscreen Mask (UI ì—°ì¶œìš©) ---------- */
  .fullscreen-mask{
    position:absolute;
    left:0;
    right:0;
    bottom:0;
    height:120px;
    z-index:9999;
    pointer-events:none;
    display:none;
    background:linear-gradient(to top, rgba(0,0,0,0.85), rgba(0,0,0,0.45), rgba(0,0,0,0));
  }
  body.theme-light .fullscreen-mask{
    background:linear-gradient(to top, rgba(249,250,251,0.95), rgba(249,250,251,0.6), rgba(249,250,251,0));
  }

  /* ---------- Record Mode (ê°€ì§œ ì „ì²´í™”ë©´) ---------- */
  body.record-mode{ overflow:hidden; }
  body.record-mode .sidebar{ display:none !important; }
  body.record-mode .main{ padding:0 !important; }

  body.record-mode .timeline-viewport{
    position:fixed !important;
    inset:0 !important;
    width:100vw !important;
    height:100dvh !important; /* ì•ˆë“œë¡œì´ë“œ ì£¼ì†Œì°½ ì´ìŠˆ ëŒ€ì‘ */
    max-width:100vw !important;
    max-height:100dvh !important;
    border-radius:0 !important;
    border:none !important;
    margin:0 !important;
    z-index:9999 !important;
    box-shadow:none !important;
  }

  .record-exit{
    position:fixed;
    top:12px;
    right:12px;
    width:40px;
    height:40px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.4);
    background:rgba(2,6,23,0.6);
    color:#fff;
    font-size:20px;
    line-height:1;
    display:none;
    z-index:10000;
  }
  body.theme-light .record-exit{
    background:rgba(249,250,251,0.8);
    color:#111827;
  }
  body.record-mode .record-exit{
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }

  /* ---------- Responsive ---------- */
  @media (max-width:768px){
    body{ flex-direction:column; height:auto; }
    .sidebar{
      width:100%;
      border-right:none;
      border-bottom:1px solid var(--border);
      padding:16px 16px;
      gap:14px;
    }
    .main{ padding:8px; }
    .timeline-viewport{
      width:100%;
      height:70vh;
      border-radius:16px;
    }
    body[data-step="1"] .sidebar{
      max-width:100%;
      border-bottom:none;
    }
    h1{ font-size:19px; }
  }

  /* ---------- Local Fonts ---------- */
  @font-face{
    font-family:"BagelFatOneLocal";
    src:url("./fonts/BagelFatOne-Regular.ttf") format("truetype");
    font-weight:400;
    font-style:normal;
    font-display:swap;
  }
  @font-face{
    font-family:"NanumNaMuJeongWeonLocal";
    src:url("./fonts/NanumNaMuJeongWeon.ttf") format("truetype");
    font-weight:400;
    font-style:normal;
    font-display:swap;
  }
  @font-face{
    font-family:"PretendardSemiBoldLocal";
    src:url("./fonts/Pretendard-SemiBold.woff") format("woff");
    font-weight:600;
    font-style:normal;
    font-display:swap;
  }
  @font-face{
    font-family:"LaudrygoLocal";
    src:url("./fonts/laudrygo Regular.woff") format("woff");
    font-weight:400;
    font-style:normal;
    font-display:swap;
  }
    /* ================================
   âœ… Step1 Section Layout
   - Step1ì„ 1/2/3 ì„¹ì…˜ìœ¼ë¡œ ëª…í™•íˆ ë¶„ë¦¬
   ================================ */

.step-panel .panel-section{
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 14px;
  background: rgba(255,255,255,0.02);
}

body.theme-light .step-panel .panel-section{
  background: rgba(2,6,23,0.02);
}

.section-title{
  font-size: 15px;
  font-weight: 800;
  margin: 0 0 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-title .badge{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 28px;
  height: 28px;
  padding: 0 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  color: var(--fg);
  font-size: 13px;
  font-weight: 800;
}

.section-sub{
  padding-top: 12px;
  margin-top: 12px;
  border-top: 1px dashed var(--border);
}

.section-sub:first-of-type{
  padding-top: 0;
  margin-top: 0;
  border-top: none;
}

.sub-title{
  font-size: 14px;
  font-weight: 750;
  margin: 0 0 10px;
  color: var(--fg);
}

/* Step1 ì•ˆì—ì„œ í°íŠ¸ í† ê¸€ ë¼ë²¨(â€œí…ìŠ¤íŠ¸ í°íŠ¸â€ ê°™ì€) ë„ˆë¬´ íŠ€ë©´ ì‚´ì§ ì¤„ì´ê¸° */
.step1-mini-label{
  font-size: 13px;
  color: var(--muted);
  margin: 0 0 8px;
}

    /* =========================
   âœ… Step1 ì„¹ì…˜ UI (ê¹”ë” ë²„ì „)
   ========================= */
.step1-sections{
  display:flex;
  flex-direction:column;
  gap:14px;
}

.s1-section{
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  background: rgba(255,255,255,0.02);
}
body.theme-light .s1-section{
  background: rgba(2,6,23,0.03);
}

.s1-head{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}

.s1-num{
  width:28px;
  height:28px;
  border-radius:999px;
  border:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:13px;
  color: var(--muted);
  flex:0 0 auto;
}

.s1-title{
  font-size:16px;
  font-weight:800;
  color: var(--fg);
}

.s1-subtitle{
  margin-top:12px;
  margin-bottom:6px;
  font-size:13px;
  font-weight:800;
  color: var(--muted);
}

.s1-divider{
  height:1px;
  background: var(--border);
  opacity:0.9;
  margin:12px 0;
}

/* ë¼ë²¨ í…ìŠ¤íŠ¸ëŠ” ì¤‘ë³µ ëŠë‚Œ ë‚˜ë©´ "ì‹œê°ì ìœ¼ë¡œë§Œ" ìˆ¨ê¹€ (ì ‘ê·¼ì„±ì€ ìœ ì§€) */
.sr-only{
  position:absolute;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}

/* âœ… í°íŠ¸ ë²„íŠ¼: í„°ì¹˜ ë†’ì´ ìœ ì§€ + ì‹œê° íŒ¨ë”© ì¤„ì´ê¸°(í°íŠ¸ ì°¨ì´ ë” í‹°ë‚˜ê²Œ) */
.title-font-toggle .toggle-btn,
.text-font-toggle .toggle-btn{
  min-height: 44px;
  padding: 0 8px;   /* ì‹œê°ì ìœ¼ë¡œ ê½‰ ì°¨ê²Œ */
  font-size: 20px;  /* í°íŠ¸ ì°¨ì´ ë³´ì´ê²Œ */
  line-height: 1;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

</style>

</head>
<body class="theme-dark" data-step="1">
  <div class="sidebar">
    <h1>
      íƒ€ì„ë¼ì¸ ì—ë””í„°
      <button id="themeToggle" class="btn-theme">ë¼ì´íŠ¸ ëª¨ë“œ</button>
    </h1>

    <div class="step-nav">
      <button type="button" class="step-btn active" data-step="1">1. ì•„ì´í…œ ì¶”ê°€</button>
      <button type="button" class="step-btn" data-step="2">2. íƒ€ì„ë¼ì¸ í¸ì§‘</button>
      <button type="button" class="step-btn" data-step="3">3. ì• ë‹ˆë©”ì´ì…˜</button>
    </div>

<!-- STEP 1 -->
<div id="step1Panel" class="step-panel active">

  <div class="step1-sections">

    <!-- 1) ë‚ ì§œ -->
    <section class="s1-section">
      <div class="s1-head">
        <div class="s1-title">ë‚ ì§œ</div>
      </div>

      <label class="sr-only" for="date">ë‚ ì§œ ì„ íƒ</label>
      <div class="row">
        <input type="date" id="date" />
        <button type="button" id="datePickerBtn" class="btn-secondary btn-date">ğŸ“…</button>
      </div>
    </section>

    <!-- 2) ì˜ìƒ ì œëª© -->
    <section class="s1-section">
      <div class="s1-head">
        <div class="s1-title">ì˜ìƒ ì œëª©</div>
      </div>

      <!-- âœ… ì¤‘ë³µ ëŠë‚Œ ë°©ì§€: ë¼ë²¨ì€ ìˆ¨ê¸°ê³  inputë§Œ ê¹”ë”í•˜ê²Œ -->
      <label class="sr-only" for="videoTitle">ì˜ìƒ ì œëª©</label>
      <input id="videoTitle" type="text" placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />

      <!-- âœ… â€œì œëª© í°íŠ¸â€ í…ìŠ¤íŠ¸ëŠ” ì œê±°í•˜ê³  ë²„íŠ¼ë§Œ -->
      <div class="title-font-toggle" id="titleFontToggle" aria-label="ì œëª© í°íŠ¸ ì„ íƒ" style="margin-top:10px;">
        <button type="button" class="toggle-btn active" data-font="pretendard">ì œëª©</button>
        <button type="button" class="toggle-btn" data-font="laudrygo">ì œëª©</button>
        <button type="button" class="toggle-btn" data-font="nanum">ì œëª©</button>
        <button type="button" class="toggle-btn" data-font="bagel">ì œëª©</button>
      </div>
    </section>

    <!-- 3) ì•„ì´í…œ ì¶”ê°€ -->
    <section class="s1-section">
      <div class="s1-head">
        <div class="s1-title">ì•„ì´í…œ ì¶”ê°€</div>
      </div>

      <!-- 3-1 ì‹œê°„ êµ¬ê°„ -->
      <div class="s1-subtitle">ì‹œê°„ êµ¬ê°„(ì‹œì‘ ~ ë)</div>
      <div class="row">
        <select id="startTime"></select>
        <select id="endTime"></select>
      </div>

      <div class="s1-divider"></div>

      <!-- 3-2 íƒ€ì…/ë‚´ìš© -->
      <div class="s1-subtitle">ì•„ì´í…œ íƒ€ì…</div>
      <div class="item-type-toggle">
        <button type="button" class="toggle-btn active" data-type="file">ì´ë¯¸ì§€/ë™ì˜ìƒ</button>
        <button type="button" class="toggle-btn" data-type="text">í…ìŠ¤íŠ¸</button>
      </div>

      <!-- í…ìŠ¤íŠ¸ -->
      <div id="textInputGroup" style="margin-top:10px;">
        <textarea id="textContent" placeholder="í…ìŠ¤íŠ¸ ì•„ì´í…œ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>

        <!-- í…ìŠ¤íŠ¸ í°íŠ¸ -->
        <div class="text-font-toggle" id="textFontToggle" aria-label="í…ìŠ¤íŠ¸ í°íŠ¸ ì„ íƒ" style="margin-top:10px;">
          <button type="button" class="toggle-btn active" data-font="pretendard">í…ìŠ¤íŠ¸</button>
          <button type="button" class="toggle-btn" data-font="laudrygo">í…ìŠ¤íŠ¸</button>
          <button type="button" class="toggle-btn" data-font="nanum">í…ìŠ¤íŠ¸</button>
          <button type="button" class="toggle-btn" data-font="bagel">í…ìŠ¤íŠ¸</button>
        </div>
      </div>

      <!-- íŒŒì¼ -->
      <div id="imageInputGroup" style="margin-top:10px;">
        <input type="file" id="imageFile" accept="image/*,video/*" />
      </div>

      <div class="s1-divider"></div>

      <!-- 3-3 ì¶”ê°€ -->
      <button id="addItemBtn" class="btn-primary">ì•„ì´í…œ ì¶”ê°€</button>
      <p id="timeSummary" class="hint" style="margin-top:10px;">ì•„ì§ ì¶”ê°€ëœ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      <ul id="blockList" class="block-list"></ul>
    </section>

  </div>
</div>

    <!-- STEP 2 --> <div id="step2Panel" class="step-panel"> <p class="hint"> íƒ€ì„ë¼ì¸ì—ì„œ ì•„ì´í…œì„ <b>ê¸¸ê²Œ ëˆ„ë¥´ë©´</b> í¸ì§‘ ëª¨ë“œë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.<br/> í¸ì§‘ ëª¨ë“œì—ì„œëŠ”: </p> <ul class="hint" style="margin: 8px 0; padding-left: 20px;"> <li>í•œ ì†ê°€ë½ ë“œë˜ê·¸ë¡œ ììœ ë¡­ê²Œ ìœ„ì¹˜ ì´ë™</li> <li>ë‘ ì†ê°€ë½ í•€ì¹˜ë¡œ í¬ê¸° ì¡°ì ˆ</li> <li>ë‘ ì†ê°€ë½ íšŒì „ìœ¼ë¡œ ê°ë„ ì¡°ì ˆ</li> </ul> <p class="hint"> ë¹ˆ ê³µê°„ì„ íƒ­í•˜ë©´ í¸ì§‘ ëª¨ë“œê°€ í•´ì œë©ë‹ˆë‹¤.<br/> ì•„ì´í…œë“¤ì´ ê²¹ì¹  ìˆ˜ ìˆìœ¼ë©°, í¸ì§‘í•˜ëŠ” ì•„ì´í…œì´ ê°€ì¥ ìœ„ì— í‘œì‹œë©ë‹ˆë‹¤. </p> </div>

    <!-- STEP 3 -->
    <div id="step3Panel" class="step-panel">

      <div style="margin-top:8px;">
        <label>ì• ë‹ˆë©”ì´ì…˜ ëª¨ë“œ</label>
        <div class="animation-mode-toggle">
          <button type="button" class="toggle-btn active" data-mode="scroll">ìŠ¤í¬ë¡¤ë§Œ</button>
          <button type="button" class="toggle-btn" data-mode="scrollReveal">ìŠ¤í¬ë¡¤ + ìˆœì°¨ ë“±ì¥</button>
        </div>
      </div>

      <div style="margin-top: 8px;">
        <label>ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ ì‹œê°„ (ì „ì²´ ìŠ¤í¬ë¡¤ ì‹œê°„)</label>
        <div class="speed-row">
          <input type="range" id="speed" min="3" max="20" step="1" value="8" />
          <span id="speedLabel">8ì´ˆ</span>
        </div>
      </div>

      <button id="playBtn" class="btn-secondary">â–¶ ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ</button>
      <button id="playFullscreenBtn" class="btn-secondary">â›¶ ì „ì²´ í™”ë©´ ì¬ìƒ</button>

      <p class="hint">
        ì „ì²´ í™”ë©´ ì¬ìƒ í›„ íœ´ëŒ€í° í™”ë©´ ë…¹í™” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´<br/>
        íƒ€ì„ë¼ì¸ ì˜ìƒìœ¼ë¡œ ë°”ë¡œ ì €ì¥í•  ìˆ˜ ìˆì–´ìš”.
      </p>
    </div>
  </div>

  <div class="main">
    <div class="step1-placeholder">
      2ë‹¨ê³„ì—ì„œ íƒ€ì„ë¼ì¸ì„ í¸ì§‘í•  ìˆ˜ ìˆì–´ìš”.<br/>
      ë¨¼ì € 1ë‹¨ê³„ì—ì„œ ì•„ì´í…œì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
    </div>

<div class="timeline-viewport" id="viewport">

  <!-- âœ… (ì¶”ê°€) ë…¹í™” ëª¨ë“œ(ê°€ì§œ ì „ì²´í™”ë©´) ì¢…ë£Œ ë²„íŠ¼ -->
  <button type="button" id="recordExitBtn" class="record-exit" aria-label="ë…¹í™” ëª¨ë“œ ì¢…ë£Œ">âœ•</button>

  <!-- (ì„ íƒ) í•˜ë‹¨ ê·¸ë¼ë°ì´ì…˜. 'ì‹œìŠ¤í…œ ì•ˆë‚´ë¬¸êµ¬'ëŠ” ëª» ê°€ë¦¬ì§€ë§Œ, UI ì—°ì¶œìš©ìœ¼ë¡œë§Œ ì‚¬ìš© -->
  <div class="fullscreen-mask"></div>

  <div class="viewport-header" id="headerLabel">
    ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
  </div>
  <div class="timeline-title-overlay" id="titleOverlay"></div>

  <div class="timeline-inner" id="timeline"></div>
</div>

  <script>
(() => {
  /* ================================
     Timeline Story Editor v2.1 (CLEAN)
     - ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ / JS ì •ë¦¬
     ================================ */

  /* ---------- Constants ---------- */
  const HOUR_HEIGHT = 120;
  const MINUTE_PX = HOUR_HEIGHT / 60;
  const TOTAL_HOURS = 48;
  const MAX_MINUTES = TOTAL_HOURS * 60;
  const MIN_ITEM_HEIGHT = 100;

  /* ---------- DOM ---------- */
  const timeline = document.getElementById('timeline');
  const viewport = document.getElementById('viewport');
  const headerLabel = document.getElementById('headerLabel');
  const titleOverlay = document.getElementById('titleOverlay');

  const dateInput = document.getElementById('date');
  const datePickerBtn = document.getElementById('datePickerBtn');

  const startTimeSelect = document.getElementById('startTime');
  const endTimeSelect = document.getElementById('endTime');

  const textContentInput = document.getElementById('textContent');
  const imageFileInput = document.getElementById('imageFile');
  const textInputGroup = document.getElementById('textInputGroup');
  const imageInputGroup = document.getElementById('imageInputGroup');

  const addItemBtn = document.getElementById('addItemBtn');
  const timeSummaryEl = document.getElementById('timeSummary');
  const blockListEl = document.getElementById('blockList');

  const themeToggleBtn = document.getElementById('themeToggle');

  const speedInput = document.getElementById('speed');
  const speedLabel = document.getElementById('speedLabel');
  const playBtn = document.getElementById('playBtn');
  const playFullscreenBtn = document.getElementById('playFullscreenBtn');
  const videoTitleInput = document.getElementById('videoTitle');

  const stepButtons = document.querySelectorAll('.step-btn');
  const itemTypeButtons = document.querySelectorAll('.item-type-toggle .toggle-btn');
  const animationModeButtons = document.querySelectorAll('.animation-mode-toggle .toggle-btn');

  const stepPanels = {
    1: document.getElementById('step1Panel'),
    2: document.getElementById('step2Panel'),
    3: document.getElementById('step3Panel')
  };

  /* ---------- Title Font Toggle ---------- */
  const titleFontButtons = document.querySelectorAll('#titleFontToggle .toggle-btn');
  let currentTitleFont = localStorage.getItem('titleFont') || 'pretendard';

  function applyTitleFont(fontKey){
    titleFontButtons.forEach(b => b.classList.toggle('active', b.dataset.font === fontKey));
    currentTitleFont = fontKey;
    localStorage.setItem('titleFont', fontKey);

    titleOverlay.classList.remove('titlefont-bagel','titlefont-nanum','titlefont-pretendard','titlefont-laudrygo');
    titleOverlay.classList.add(`titlefont-${fontKey}`);
  }

  titleFontButtons.forEach(btn => {
    btn.addEventListener('click', () => applyTitleFont(btn.dataset.font));
  });

  /* ---------- Text Font Toggle ---------- */
  const textFontButtons = document.querySelectorAll('#textFontToggle .toggle-btn');
  let currentTextFont = localStorage.getItem('textFont') || 'pretendard';

  function applyTextFont(fontKey){
    textFontButtons.forEach(b => b.classList.toggle('active', b.dataset.font === fontKey));
    currentTextFont = fontKey;
    localStorage.setItem('textFont', fontKey);
  }

  textFontButtons.forEach(btn => {
    btn.addEventListener('click', () => applyTextFont(btn.dataset.font));
  });

  /* ---------- State ---------- */
  let currentItemType = 'file';
  let currentAnimationMode = 'scroll';

  let blocks = [];
  let items = [];

  let editingItemEl = null;
  let animFrameId = null;

  // gesture
  let activeTouches = [];
  let gestureState = null;

  let longPressTimer = null;
  let longPressStartPos = null;
  let zCounter = 1;

  /* ---------- Utils ---------- */
  function minutesToTimeLabel(totalMinutes) {
    const isNext = totalMinutes >= 1440;
    let m = totalMinutes;
    if (isNext) m -= 1440;

    const h = Math.floor(m / 60);
    const mm = m % 60;

    const hh = String(h).padStart(2,'0');
    const mmStr = String(mm).padStart(2,'0');
    const base = `${hh}:${mmStr}`;

    return isNext ? `ë‹¤ìŒë‚  ${base}` : base;
  }

  function clamp(n, min, max){ return Math.max(min, Math.min(n, max)); }

  /* ---------- Block / List ---------- */
  function updateBlockList() {
    blockListEl.innerHTML = '';
    if (!blocks.length) return;

    const sorted = blocks.slice().sort((a,b)=>a.startMinutes - b.startMinutes);

    sorted.forEach(b => {
      const li = document.createElement('li');
      li.dataset.blockId = b.id;

      const timeSpan = document.createElement('span');
      timeSpan.className = 'time';
      timeSpan.textContent =
        minutesToTimeLabel(b.startMinutes) + ' ~ ' + minutesToTimeLabel(b.endMinutes);

      const countSpan = document.createElement('span');
      countSpan.className = 'count';
      countSpan.textContent = `ì•„ì´í…œ ${items.filter(it => it.blockId === b.id).length}ê°œ`;

      const delBtn = document.createElement('button');
      delBtn.className = 'block-delete-btn';
      delBtn.textContent = 'âœ•';
      delBtn.addEventListener('click', ev => {
        ev.stopPropagation();
        if (confirm('ì´ ì‹œê°„ ë¸”ë¡ ì „ì²´ë¥¼ ì‚­ì œí• ê¹Œìš”?')) deleteBlockById(b.id);
      });

      const rightGroup = document.createElement('div');
      rightGroup.className = 'block-right-group';
      rightGroup.appendChild(countSpan);
      rightGroup.appendChild(delBtn);

      li.appendChild(timeSpan);
      li.appendChild(rightGroup);

      li.addEventListener('click', () => scrollToBlock(b.id));
      blockListEl.appendChild(li);
    });
  }

  function updateTimeSummary() {
    if (!blocks.length) {
      timeSummaryEl.textContent = 'ì•„ì§ ì¶”ê°€ëœ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.';
      blockListEl.innerHTML = '';
      return;
    }
    timeSummaryEl.textContent = `ì¶”ê°€ëœ ì‹œê°„ ë¸”ë¡: ${blocks.length}ê°œ`;
    updateBlockList();
  }

  function scrollToBlock(blockId) {
    const block = blocks.find(b => b.id === blockId);
    if (!block || !block.element) return;

    const blockTop = parseFloat(block.element.style.top) || 0;
    const blockHeight = block.element.offsetHeight || 0;

    const viewportHeight = viewport.clientHeight;
    const maxScroll = Math.max(0, timeline.scrollHeight - viewportHeight);

    let target = blockTop - (viewportHeight - blockHeight) / 2;
    target = clamp(target, 0, maxScroll);

    viewport.scrollTo({ top: target, behavior: 'smooth' });

    block.element.classList.add('highlight');
    setTimeout(()=>block.element.classList.remove('highlight'), 800);
  }

  function deleteBlockById(blockId) {
    const block = blocks.find(b => b.id === blockId);
    if (!block) return;

    const blockItems = items.filter(it => it.blockId === blockId);
    blockItems.forEach(it => {
      const el = timeline.querySelector(`.timeline-item[data-id="${it.id}"]`);
      if (el && el.parentElement) el.parentElement.removeChild(el);
    });

    items = items.filter(it => it.blockId !== blockId);

    if (block.element && block.element.parentElement) {
      block.element.parentElement.removeChild(block.element);
    }
    blocks = blocks.filter(b => b.id !== blockId);

    editingItemEl = null;
    updateTimeSummary();
  }

  /* ---------- Time Options ---------- */
  function updateEndTimeOptions(startMinutes) {
    endTimeSelect.innerHTML = '';
    const minEnd = startMinutes + 30;
    for (let m=minEnd; m<=MAX_MINUTES; m+=30) {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = minutesToTimeLabel(m);
      endTimeSelect.appendChild(opt);
    }
  }

  function buildTimeOptions() {
    startTimeSelect.innerHTML = '';
    for (let m=0; m<=MAX_MINUTES-30; m+=30) {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = minutesToTimeLabel(m);
      if (m===7*60) opt.selected = true;
      startTimeSelect.appendChild(opt);
    }
    updateEndTimeOptions(parseInt(startTimeSelect.value,10));
  }

  /* ---------- Grid ---------- */
  function buildHourGrid() {
    for (let h=0; h<TOTAL_HOURS; h++) {
      const top = h * HOUR_HEIGHT;

      const label = document.createElement('div');
      label.className='hour-label';
      label.style.top = (top+4)+'px';
      label.textContent = minutesToTimeLabel(h*60);

      const line = document.createElement('div');
      line.className='hour-line';
      line.style.top = (top+20)+'px';

      timeline.appendChild(label);
      timeline.appendChild(line);
    }
  }

  function clearHourHighlight() {
    document.querySelectorAll('.hour-label').forEach(l => l.classList.remove('active'));
  }

  function highlightHourByScroll(scrollTop) {
    const viewportHeight = viewport.clientHeight;
    const centerY = scrollTop + viewportHeight/2;
    const minutes = centerY / MINUTE_PX;
    const hourIndex = Math.floor(minutes/60);

    clearHourHighlight();

    const labels = document.querySelectorAll('.hour-label');
    if (hourIndex>=0 && hourIndex<labels.length) labels[hourIndex].classList.add('active');
  }

  function resetTimelineDataAndDom() {
    blocks = [];
    items = [];
    editingItemEl = null;
    stopAnimation();
    clearHourHighlight();
    exitEditMode();

    while (timeline.firstChild) timeline.removeChild(timeline.firstChild);
    timeline.style.height = (TOTAL_HOURS*HOUR_HEIGHT)+'px';

    buildHourGrid();
    updateTimeSummary();
  }

  /* ---------- Blocks ---------- */
  function getOrCreateBlock(startMinutes,endMinutes){
    const blockId = `block-${startMinutes}-${endMinutes}`;
    let block = blocks.find(b=>b.id===blockId);
    if (block) return block;

    const top = startMinutes * MINUTE_PX;
    const height = (endMinutes-startMinutes) * MINUTE_PX;

    const blockEl = document.createElement('div');
    blockEl.className='time-block';
    blockEl.style.top = top+'px';
    blockEl.style.height = height+'px';
    blockEl.dataset.id = blockId;

    const inner = document.createElement('div');
    inner.className='time-block-inner';
    blockEl.appendChild(inner);
    timeline.appendChild(blockEl);

    block = {id:blockId,startMinutes,endMinutes,duration:endMinutes-startMinutes,element:blockEl};
    blocks.push(block);
    updateTimeSummary();
    return block;
  }

  /* ---------- Items ---------- */
  function getItemByElement(el){
    const id=el.dataset.id;
    return items.find(it=>it.id===id);
  }

  function createItemElement(item) {
    const el = document.createElement('div');
    el.className = 'timeline-item';
    el.dataset.id = item.id;
    el.style.left = item.x + 'px';
    el.style.top = item.y + 'px';
    el.style.width = item.w + 'px';
    el.style.height = item.h + 'px';
    el.style.transform = `rotate(${item.rotation || 0}rad)`;
    el.dataset.rotation = item.rotation || 0;
    el.style.zIndex = (++zCounter).toString();

    if (item.type === 'image') {
      const img = document.createElement('img');
      img.src = item.src;
      img.style.objectFit = 'contain';
      el.appendChild(img);
    } else if (item.type === 'video') {
      const v = document.createElement('video');
      v.src = item.src;
      v.muted = true;
      v.loop = true;
      v.autoplay = true;
      v.playsInline = true;
      v.style.objectFit = 'contain';
      el.appendChild(v);
    } else {
      const t = document.createElement('div');
      t.className = 'timeline-item-text';
      t.textContent = item.text;

      const fontMap = {
        pretendard: '"PretendardSemiBoldLocal","Pretendard",system-ui,sans-serif',
        laudrygo: '"LaudrygoLocal",system-ui,sans-serif',
        nanum: '"NanumNaMuJeongWeonLocal",system-ui,sans-serif',
        bagel: '"BagelFatOneLocal",system-ui,sans-serif'
      };

      const key = item.fontKey || 'pretendard';
      t.style.fontFamily = fontMap[key] || fontMap.pretendard;
      t.style.fontSize = (item.fontSize || 24) + 'px'; // ìµœì†Œ 24px ë³´ì¥
      el.appendChild(t);
    }

    // ì œìŠ¤ì²˜ ì´ë²¤íŠ¸
    el.addEventListener('pointerdown', onGesturePointerDown);
    el.addEventListener('pointermove', onGesturePointerMove);
    el.addEventListener('pointerup', onGesturePointerUp);
    el.addEventListener('pointercancel', onGesturePointerUp);

    el.addEventListener('contextmenu', e => e.preventDefault());
    el.addEventListener('dragstart', e => e.preventDefault());

    el.style.touchAction = 'none';
    el.style.userSelect = 'none';
    el.style.webkitUserSelect = 'none';

    timeline.appendChild(el);
    return el;
  }

  /* ---------- Edit Mode ---------- */
  function enterEditMode(el) {
    exitEditMode();
    editingItemEl = el;
    el.classList.add('edit-mode','editing');
    viewport.classList.add('edit-mode');
    el.style.zIndex = (++zCounter).toString();
  }

  function exitEditMode() {
    if (editingItemEl) {
      editingItemEl.classList.remove('edit-mode','editing');
      editingItemEl = null;
    }
    viewport.classList.remove('edit-mode');
  }

  /* ---------- Animation ---------- */
  function stopAnimation(){
    if (animFrameId!==null){
      cancelAnimationFrame(animFrameId);
      animFrameId=null;
    }
  }

  function runAnimation(){
    if (!blocks.length){
      alert('ë¨¼ì € ì‹œê°„ ë¸”ë¡ì— ì•„ì´í…œì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.');
      return;
    }

    stopAnimation();
    exitEditMode();

    const mode = currentAnimationMode;
    const blocksSorted = blocks.slice().sort((a,b)=>a.startMinutes - b.startMinutes);
    const viewportHeight = viewport.clientHeight;

    const tops = blocks.map(b => parseFloat(b.element.style.top) || 0);
    const bottoms = blocks.map(b => {
      const top = parseFloat(b.element.style.top) || 0;
      return top + b.element.offsetHeight;
    });

    const minTop = Math.min(...tops);
    const maxBottom = Math.max(...bottoms);

    let endScroll = Math.max(maxBottom - viewportHeight + 40, 0);

    const itemEls = timeline.querySelectorAll('.timeline-item');
    const durationSec = parseFloat(speedInput.value) || 8;
    const durationMs = durationSec * 1000;

    const title = videoTitleInput.value.trim();
    const hasTitle = !!title;

    function clampEndToStart(start){
      if (endScroll < start) endScroll = start;
    }

    function startScrollAnimationFrom(startScroll){
      if (mode === 'scrollReveal'){
        itemEls.forEach(el=>{
          el.classList.remove('reveal-visible');
          el.classList.add('reveal-hidden');
        });
      } else {
        itemEls.forEach(el=>{
          el.classList.remove('reveal-hidden','reveal-visible');
        });
      }

      const startTime = performance.now();

      function frame(now){
        const t = Math.min(1, (now - startTime) / durationMs);
        const current = startScroll + (endScroll - startScroll) * t;

        viewport.scrollTop = current;
        highlightHourByScroll(current);

        if (mode === 'scrollReveal'){
          const triggerLine = current + viewportHeight * 0.4;

          blocksSorted.forEach(block=>{
            const blockTop = parseFloat(block.element.style.top) || 0;
            const threshold = blockTop + block.element.offsetHeight * 0.2;

            if (triggerLine >= threshold){
              items.filter(it => it.blockId === block.id).forEach(it=>{
                const el = timeline.querySelector(`.timeline-item[data-id="${it.id}"]`);
                if (el && el.classList.contains('reveal-hidden')){
                  el.classList.remove('reveal-hidden');
                  el.classList.add('reveal-visible');
                }
              });
            }
          });
        }

        if (t < 1){
          animFrameId = requestAnimationFrame(frame);
        } else {
          animFrameId = null;
          clearHourHighlight();
        }
      }

      animFrameId = requestAnimationFrame(frame);
    }

    if (hasTitle){
      titleOverlay.textContent = title;
      titleOverlay.style.display = 'flex';

      const initialScroll = Math.max(minTop - viewportHeight * 0.9, 0);
      clampEndToStart(initialScroll);

      viewport.scrollTop = initialScroll;
      highlightHourByScroll(initialScroll);

      setTimeout(()=>{
        titleOverlay.style.display = 'none';
        startScrollAnimationFrom(initialScroll);
      }, 5000);

    } else {
      const startScroll = Math.max(minTop - 40, 0);
      clampEndToStart(startScroll);

      viewport.scrollTop = startScroll;
      highlightHourByScroll(startScroll);
      startScrollAnimationFrom(startScroll);
    }
  }

  /* ---------- Record Mode (Fake Fullscreen) ---------- */
  const recordExitBtn = document.getElementById('recordExitBtn');

  function enterRecordMode() {
    document.body.classList.add('record-mode');
    const mask = viewport.querySelector('.fullscreen-mask');
    if (mask) mask.style.display = 'block';
  }

  function exitRecordMode() {
    document.body.classList.remove('record-mode');
    stopAnimation();
    clearHourHighlight();
    const mask = viewport.querySelector('.fullscreen-mask');
    if (mask) mask.style.display = 'none';
  }

  /* ---------- Gestures ---------- */
  function onGesturePointerDown(e) {
    e.preventDefault();

    const el = e.currentTarget;
    el.setPointerCapture(e.pointerId);

    activeTouches.push({ id:e.pointerId, x:e.clientX, y:e.clientY });

    const item = getItemByElement(el);

    // 1 finger: long press to enter edit mode
    if (activeTouches.length === 1) {
      longPressStartPos = { x:e.clientX, y:e.clientY };

      longPressTimer = setTimeout(() => {
        enterEditMode(el);
        gestureState = {
          mode:'move',
          startX:e.clientX,
          startY:e.clientY,
          origX:item.x,
          origY:item.y
        };
      }, 500);
    }

    // 2 fingers: transform (only in edit mode)
    if (activeTouches.length === 2 && editingItemEl === el) {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }

      const [t1, t2] = activeTouches;
      const dx = t2.x - t1.x;
      const dy = t2.y - t1.y;

      gestureState = {
        mode:'transform',
        startDist: Math.hypot(dx,dy),
        startAngle: Math.atan2(dy,dx),
        startRotation: item.rotation || 0,
        rotationSensitivity: 0.3,
        startWidth: item.w,
        startHeight: item.h
      };
    }
  }

  function onGesturePointerMove(e) {
    const el = e.currentTarget;
    const item = getItemByElement(el);

    if (longPressTimer && longPressStartPos) {
      const dx = Math.abs(e.clientX - longPressStartPos.x);
      const dy = Math.abs(e.clientY - longPressStartPos.y);
      if (dx > 10 || dy > 10) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
        longPressStartPos = null;
      }
    }

    activeTouches = activeTouches.map(t =>
      t.id === e.pointerId ? { ...t, x:e.clientX, y:e.clientY } : t
    );

    if (!gestureState) return;

    // move
    if (gestureState.mode === 'move' && activeTouches.length === 1 && editingItemEl === el) {
      e.preventDefault();

      const dx = e.clientX - gestureState.startX;
      const dy = e.clientY - gestureState.startY;

      const newX = gestureState.origX + dx;
      const newY = gestureState.origY + dy;

      el.style.left = `${newX}px`;
      el.style.top = `${newY}px`;
      void el.offsetHeight;

      item.x = newX;
      item.y = newY;
    }

    // transform
    if (gestureState.mode === 'transform' && activeTouches.length === 2 && editingItemEl === el) {
      e.preventDefault();

      const [t1, t2] = activeTouches;
      const dx = t2.x - t1.x;
      const dy = t2.y - t1.y;

      const dist = Math.hypot(dx,dy);
      const scale = dist / gestureState.startDist;

      const angle = Math.atan2(dy,dx);
      const angleDiff = angle - gestureState.startAngle;
      const rotation = gestureState.startRotation + (angleDiff * gestureState.rotationSensitivity);

      const newW = gestureState.startWidth * scale;
      const newH = gestureState.startHeight * scale;

      el.style.width = `${newW}px`;
      el.style.height = `${newH}px`;
      el.style.transform = `rotate(${rotation}rad)`;
      void el.offsetHeight;

      item.w = newW;
      item.h = newH;
      item.rotation = rotation;
    }
  }

  function onGesturePointerUp(e) {
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      longPressTimer = null;
    }
    longPressStartPos = null;

    activeTouches = activeTouches.filter(t => t.id !== e.pointerId);
    if (activeTouches.length === 0) gestureState = null;
  }

  /* ---------- Events ---------- */
  // ì´ˆê¸° ì ìš©
  applyTitleFont(currentTitleFont);
  applyTextFont(currentTextFont);

  buildTimeOptions();
  resetTimelineDataAndDom();

  const today = new Date().toISOString().slice(0,10);
  dateInput.value = today;
  headerLabel.textContent = today + ' íƒ€ì„ë¼ì¸';

  dateInput.addEventListener('change', () => {
    headerLabel.textContent = dateInput.value + ' íƒ€ì„ë¼ì¸';
    resetTimelineDataAndDom();
  });

  datePickerBtn.addEventListener('click', () => {
    if (typeof dateInput.showPicker === 'function') dateInput.showPicker();
    else { dateInput.focus(); dateInput.click(); }
  });

  startTimeSelect.addEventListener('change', () => {
    updateEndTimeOptions(parseInt(startTimeSelect.value,10));
  });

  itemTypeButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      itemTypeButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentItemType = btn.dataset.type;

      if (currentItemType==='text') {
        textInputGroup.style.display='block';
        imageInputGroup.style.display='none';
      } else {
        textInputGroup.style.display='none';
        imageInputGroup.style.display='block';
      }
    });
  });

  animationModeButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      animationModeButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentAnimationMode = btn.dataset.mode;
    });
  });

  // ê¸°ë³¸ í‘œì‹œ ìƒíƒœ
  textInputGroup.style.display='none';
  imageInputGroup.style.display='block';

  speedInput.addEventListener('input',()=>{ speedLabel.textContent = speedInput.value + 'ì´ˆ'; });

  addItemBtn.addEventListener('click',()=>{
    if (!dateInput.value){
      alert('ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const startMinutes = parseInt(startTimeSelect.value,10);
    const endMinutes = parseInt(endTimeSelect.value,10);

    if (isNaN(startMinutes)||isNaN(endMinutes)||endMinutes<=startMinutes){
      alert('ì‹œì‘/ë ì‹œê°„ì„ ì˜¬ë°”ë¥´ê²Œ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const itemData = {
      id:'item-'+Date.now()+'-'+Math.random().toString(16).slice(2),
      blockId:null,
      type:'',
      x:0,y:0,w:0,h:0,
      rotation:0
    };

    let itemType;

    if (currentItemType==='text'){
      const text = textContentInput.value.trim();
      if (!text){ alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      itemType='text';
      itemData.text=text;
      itemData.fontKey = currentTextFont;
    } else {
      const file = imageFileInput.files[0];
      if (!file){ alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
      itemData.src = URL.createObjectURL(file);
      itemType = file.type && file.type.startsWith('video/') ? 'video' : 'image';
    }

    itemData.type=itemType;

    const block = getOrCreateBlock(startMinutes,endMinutes);
    itemData.blockId=block.id;

    const blockRect = block.element.getBoundingClientRect();
    const blockTop = parseFloat(block.element.style.top) || 0;
    const blockHeight = parseFloat(block.element.style.height) || 0;

    const existing = items.filter(it=>it.blockId===block.id);

    if (!existing.length){
      const padding=12;
      const availableWidth = blockRect.width - 32;
      const availableHeight = Math.max(MIN_ITEM_HEIGHT, blockHeight - padding*2);

      itemData.x=70;
      itemData.y=blockTop + padding;
      itemData.w=availableWidth;
      itemData.h=availableHeight;
    } else {
      const w = Math.max(80, blockRect.width*0.5);
      const h = Math.max(MIN_ITEM_HEIGHT, Math.max(80, blockRect.height*0.5));

      itemData.w=w; itemData.h=h;
      itemData.x=70 + (blockRect.width-w)/2;
      itemData.y=blockTop + (blockRect.height-h)/2;
    }

    items.push(itemData);
    createItemElement(itemData);

    scrollToBlock(block.id);

    if (itemType==='image'||itemType==='video') imageFileInput.value='';
    updateBlockList();
  });

  playBtn.addEventListener('click', runAnimation);

  playFullscreenBtn.addEventListener('click', () => {
    enterRecordMode();
    requestAnimationFrame(() => requestAnimationFrame(() => runAnimation()));
  });

  recordExitBtn.addEventListener('click', exitRecordMode);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') exitRecordMode(); });

  viewport.addEventListener('scroll',()=>{
    if (animFrameId===null) highlightHourByScroll(viewport.scrollTop);
  });

  stepButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const step = btn.dataset.step;
      stepButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      Object.entries(stepPanels).forEach(([key,p])=>{
        if (key===step) p.classList.add('active');
        else p.classList.remove('active');
      });

      document.body.dataset.step = step;
    });
  });

  themeToggleBtn.addEventListener('click', () => {
    const body = document.body;
    if (body.classList.contains('theme-dark')) {
      body.classList.remove('theme-dark');
      body.classList.add('theme-light');
      themeToggleBtn.textContent = 'ë‹¤í¬ ëª¨ë“œ';
    } else {
      body.classList.remove('theme-light');
      body.classList.add('theme-dark');
      themeToggleBtn.textContent = 'ë¼ì´íŠ¸ ëª¨ë“œ';
    }
  });

  // íƒ€ì„ë¼ì¸ ë°°ê²½ í´ë¦­ ì‹œ í¸ì§‘ ëª¨ë“œ í•´ì œ
  timeline.addEventListener('click', (e) => {
    if (e.target === timeline || e.target.classList.contains('timeline-inner')) {
      exitEditMode();
    }
  });

})();
</script>

</body>
</html>











